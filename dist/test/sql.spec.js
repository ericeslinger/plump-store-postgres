"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var pg = require("pg");
var chai = require("chai");
var chaiAsPromised = require("chai-as-promised");
var mergeOptions = require("merge-options");
require("mocha");
var index_1 = require("../src/index");
var testType_1 = require("./testType");
var storageTests_1 = require("./storageTests");
chai.use(chaiAsPromised);
var expect = chai.expect;
function runSQL(command, opts) {
    if (opts === void 0) { opts = {}; }
    var connOptions = Object.assign({}, {
        user: 'postgres',
        host: 'localhost',
        port: 5432,
        database: 'postgres',
        charset: 'utf8',
    }, opts);
    var client = new pg.Client(connOptions);
    return new Promise(function (resolve) {
        client.connect(function (err) {
            if (err) {
                throw err;
            }
            client.query(command, function (err) {
                if (err) {
                    throw err;
                }
                client.end(function (err) {
                    if (err) {
                        throw err;
                    }
                    resolve();
                });
            });
        });
    });
}
function createDatabase(name) {
    return runSQL("DROP DATABASE if exists " + name + ";")
        .then(function () { return runSQL("CREATE DATABASE " + name + ";"); })
        .then(function () {
        return runSQL("\n      CREATE SEQUENCE testid_seq\n        START WITH 1\n        INCREMENT BY 1\n        NO MINVALUE\n        MAXVALUE 2147483647\n        CACHE 1\n        CYCLE;\n      CREATE TABLE tests (\n        id integer not null primary key DEFAULT nextval('testid_seq'::regclass),\n        name text,\n        \"otherName\" text,\n        extended jsonb not null default '{}'::jsonb\n      );\n      CREATE TABLE parent_child_relationship (parent_id integer not null, child_id integer not null);\n      CREATE UNIQUE INDEX children_join on parent_child_relationship (parent_id, child_id);\n      CREATE TABLE valence_children (parent_id integer not null, child_id integer not null, perm integer not null);\n      CREATE UNIQUE INDEX valence_children_join on valence_children (parent_id, child_id);\n      CREATE TABLE query_children (parent_id integer not null, child_id integer not null, perm integer not null);\n      CREATE UNIQUE INDEX query_children_join on query_children (parent_id, child_id);\n    ", { database: name });
    });
}
storageTests_1.testSuite({
    describe: describe, it: it, before: before, after: after,
}, {
    ctor: index_1.PGStore,
    opts: {
        sql: {
            connection: {
                database: 'plump_test',
                user: 'postgres',
                host: 'localhost',
                port: 5432,
            },
        },
        terminal: true,
    },
    name: 'Plump Postgres Store',
    before: function () { return createDatabase('plump_test'); },
    after: function (driver) {
        return driver.teardown()
            .then(function () { return runSQL('DROP DATABASE plump_test;'); });
    },
});
var sampleObject = {
    typeName: 'tests',
    attributes: {
        name: 'potato',
        otherName: 'elephantine',
        extended: {
            actual: 'rutabaga',
            otherValue: 42,
        },
    },
};
describe('postgres-specific behaviors', function () {
    var store;
    before(function () {
        return createDatabase('secondary_plump_test')
            .then(function () {
            store = new index_1.PGStore({
                sql: {
                    connection: {
                        database: 'secondary_plump_test',
                        user: 'postgres',
                        host: 'localhost',
                        port: 5432,
                    },
                },
                terminal: true,
            });
            return store.addSchema(testType_1.TestType);
        });
    });
    it('Returns extra contents', function () {
        return store.writeAttributes(sampleObject)
            .then(function (createdObject) {
            return store.writeRelationshipItem(createdObject, 'valenceChildren', { id: 100, meta: { perm: 1 } })
                .then(function () { return store.writeRelationshipItem(createdObject, 'queryChildren', { id: 101, meta: { perm: 1 } }); })
                .then(function () { return store.writeRelationshipItem(createdObject, 'queryChildren', { id: 102, meta: { perm: 2 } }); })
                .then(function () { return store.writeRelationshipItem(createdObject, 'queryChildren', { id: 103, meta: { perm: 3 } }); })
                .then(function () {
                var resultObject = mergeOptions({}, createdObject, {
                    relationships: {
                        queryChildren: [
                            { id: 102, meta: { perm: 2 } },
                            { id: 103, meta: { perm: 3 } },
                        ],
                        queryParents: [],
                        valenceChildren: [
                            { id: 100, meta: { perm: 1 } },
                        ],
                        valenceParents: [],
                        children: [],
                        parents: [],
                    }
                });
                return store.read(createdObject)
                    .then(function (res) {
                    return expect(res).to.deep.equal(resultObject);
                });
            });
        });
    });
    it('supports all hasMany relationships', function () {
        return store.writeAttributes(sampleObject)
            .then(function (createdObject) {
            return store.writeRelationshipItem(createdObject, 'queryChildren', { id: 101, meta: { perm: 1 } })
                .then(function () { return store.writeRelationshipItem(createdObject, 'queryChildren', { id: 102, meta: { perm: 2 } }); })
                .then(function () { return store.writeRelationshipItem(createdObject, 'queryChildren', { id: 103, meta: { perm: 3 } }); })
                .then(function () { return store.writeRelationshipItem(createdObject, 'children', { id: 102 }); })
                .then(function () { return store.writeRelationshipItem(createdObject, 'children', { id: 103 }); })
                .then(function () { return store.writeRelationshipItem(createdObject, 'valenceChildren', { id: 102, meta: { perm: 20 } }); })
                .then(function () { return store.writeRelationshipItem(createdObject, 'valenceChildren', { id: 103, meta: { perm: 30 } }); })
                .then(function () { return store.readRelationship(createdObject, 'relationships.queryChildren'); })
                .then(function (v) { return expect(v.relationships.queryChildren).to.deep.equal([{ id: 102, meta: { perm: 2 } }, { id: 103, meta: { perm: 3 } }]); })
                .then(function () { return store.readRelationship(createdObject, 'relationships.children'); })
                .then(function (v) { return expect(v.relationships.children).to.deep.equal([{ id: 102 }, { id: 103 }]); })
                .then(function () { return store.readRelationship(createdObject, 'relationships.valenceChildren'); })
                .then(function (v) { return expect(v.relationships.valenceChildren).to.deep.equal([{ id: 102, meta: { perm: 20 } }, { id: 103, meta: { perm: 30 } }]); });
        });
    });
    it('returns many objects in a bulk Query', function () {
        return Promise.all([
            store.writeAttributes(sampleObject),
            store.writeAttributes(sampleObject),
            store.writeAttributes(sampleObject),
            store.writeAttributes(sampleObject),
            store.writeAttributes(sampleObject),
        ])
            .then(function (created) {
            var createdObject = created[0];
            return Promise.all(created.map(function (obj) {
                return Promise.all([
                    store.writeRelationshipItem(obj, 'children', { id: obj.id * 100 + 1 }),
                    store.writeRelationshipItem(obj, 'children', { id: obj.id * 100 + 2 }),
                    store.writeRelationshipItem(obj, 'children', { id: obj.id * 100 + 3 }),
                ]);
            }))
                .then(function () { return store.bulkRead(createdObject); })
                .then(function (res) {
                expect(res).to.have.property('included').with.length(4);
                res.included.forEach(function (i) {
                    expect(i.relationships.children).to.deep.equal([
                        { id: i.id * 100 + 1 },
                        { id: i.id * 100 + 2 },
                        { id: i.id * 100 + 3 },
                    ]);
                });
            });
        });
    });
    after(function () {
        return store.teardown()
            .then(function () { return runSQL('DROP DATABASE secondary_plump_test;'); });
    });
});

//# sourceMappingURL=data:application/json;charset=utf8;base64,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QUFFLEVBQUUsQ0FBQyxDQUFDLEVBQUUsR0FBRyxHQUFHLEdBQUcsQ0FBQyxFQUFFO3FCQUN2QixDQUFDLENBQUM7Z0JBQ0wsQ0FBQyxDQUFDLENBQUM7WUFDTCxDQUFDLENBQUMsQ0FBQztRQUNMLENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQyxDQUFDLENBQUM7SUFFSCxLQUFLLENBQUM7UUFDSixNQUFNLENBQUMsS0FBSyxDQUFDLFFBQVEsRUFBRTthQUN0QixJQUFJLENBQUMsY0FBTSxPQUFBLE1BQU0sQ0FBQyxxQ0FBcUMsQ0FBQyxFQUE3QyxDQUE2QyxDQUFDLENBQUM7SUFDN0QsQ0FBQyxDQUFDLENBQUM7QUFDTCxDQUFDLENBQUMsQ0FBQyIsImZpbGUiOiJ0ZXN0L3NxbC5zcGVjLmpzIiwic291cmNlc0NvbnRlbnQiOlsiLyogZXNsaW50LWVudiBub2RlLCBtb2NoYSovXG4vKiBlc2xpbnQgbm8tc2hhZG93OiAwICovXG5cbmltcG9ydCAqIGFzIHBnIGZyb20gJ3BnJztcbmltcG9ydCAqIGFzIGNoYWkgZnJvbSAnY2hhaSc7XG5pbXBvcnQgKiBhcyBjaGFpQXNQcm9taXNlZCBmcm9tICdjaGFpLWFzLXByb21pc2VkJztcbmltcG9ydCAqIGFzIG1lcmdlT3B0aW9ucyBmcm9tICdtZXJnZS1vcHRpb25zJztcbmltcG9ydCAnbW9jaGEnO1xuXG5pbXBvcnQgeyBQR1N0b3JlIH0gZnJvbSAnLi4vc3JjL2luZGV4JztcbmltcG9ydCB7IFRlc3RUeXBlIH0gZnJvbSAnLi90ZXN0VHlwZSc7XG5pbXBvcnQgeyB0ZXN0U3VpdGUgfSBmcm9tICcuL3N0b3JhZ2VUZXN0cyc7XG5cbmltcG9ydCB7IEluZGVmaW5pdGVNb2RlbERhdGEgfSBmcm9tICdwbHVtcCc7XG5cbmNoYWkudXNlKGNoYWlBc1Byb21pc2VkKTtcbmNvbnN0IGV4cGVjdCA9IGNoYWkuZXhwZWN0O1xuXG4vLyBUZXN0VHlwZS4kc2NoZW1hLnF1ZXJ5Q2hpbGRyZW4ucmVsYXRpb25zaGlwLiRzaWRlcy5xdWVyeUNoaWxkcmVuLnNlbGYucXVlcnkucmF3Sm9pbiA9XG4vLyAnbGVmdCBvdXRlciBqb2luIHF1ZXJ5X2NoaWxkcmVuIGFzIHF1ZXJ5Y2hpbGRyZW4gb24gcXVlcnljaGlsZHJlbi5wYXJlbnRfaWQgPSB0ZXN0cy5pZCBhbmQgcXVlcnljaGlsZHJlbi5wZXJtID49IDInO1xuLy8gVGVzdFR5cGUuJHNjaGVtYS5xdWVyeVBhcmVudHMucmVsYXRpb25zaGlwLiRzaWRlcy5xdWVyeVBhcmVudHMuc2VsZi5xdWVyeS5yYXdKb2luID1cbi8vICdsZWZ0IG91dGVyIGpvaW4gcXVlcnlfY2hpbGRyZW4gYXMgcXVlcnlwYXJlbnRzIG9uIHF1ZXJ5cGFyZW50cy5jaGlsZF9pZCA9IHRlc3RzLmlkIGFuZCBxdWVyeXBhcmVudHMucGVybSA+PSAyJztcbi8vXG5cblxuZnVuY3Rpb24gcnVuU1FMKGNvbW1hbmQsIG9wdHMgPSB7fSkge1xuICBjb25zdCBjb25uT3B0aW9ucyA9IE9iamVjdC5hc3NpZ24oXG4gICAge30sXG4gICAge1xuICAgICAgdXNlcjogJ3Bvc3RncmVzJyxcbiAgICAgIGhvc3Q6ICdsb2NhbGhvc3QnLFxuICAgICAgcG9ydDogNTQzMixcbiAgICAgIGRhdGFiYXNlOiAncG9zdGdyZXMnLFxuICAgICAgY2hhcnNldDogJ3V0ZjgnLFxuICAgIH0sXG4gICAgb3B0c1xuICApO1xuICBjb25zdCBjbGllbnQgPSBuZXcgcGcuQ2xpZW50KGNvbm5PcHRpb25zKTtcbiAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlKSA9PiB7XG4gICAgY2xpZW50LmNvbm5lY3QoKGVycikgPT4ge1xuICAgICAgaWYgKGVycikge1xuICAgICAgICB0aHJvdyBlcnI7XG4gICAgICB9XG4gICAgICBjbGllbnQucXVlcnkoY29tbWFuZCwgKGVycikgPT4geyAvLyB0c2xpbnQ6ZGlzYWJsZS1saW5lIG5vLXNoYWRvd2VkLXZhcmlhYmxlXG4gICAgICAgIGlmIChlcnIpIHtcbiAgICAgICAgICB0aHJvdyBlcnI7XG4gICAgICAgIH1cbiAgICAgICAgY2xpZW50LmVuZCgoZXJyKSA9PiB7IC8vIHRzbGludDpkaXNhYmxlLWxpbmUgbm8tc2hhZG93ZWQtdmFyaWFibGVcbiAgICAgICAgICBpZiAoZXJyKSB7XG4gICAgICAgICAgICB0aHJvdyBlcnI7XG4gICAgICAgICAgfVxuICAgICAgICAgIHJlc29sdmUoKTtcbiAgICAgICAgfSk7XG4gICAgICB9KTtcbiAgICB9KTtcbiAgfSk7XG59XG5cbmZ1bmN0aW9uIGNyZWF0ZURhdGFiYXNlKG5hbWUpIHtcbiAgcmV0dXJuIHJ1blNRTChgRFJPUCBEQVRBQkFTRSBpZiBleGlzdHMgJHtuYW1lfTtgKVxuICAudGhlbigoKSA9PiBydW5TUUwoYENSRUFURSBEQVRBQkFTRSAke25hbWV9O2ApKVxuICAudGhlbigoKSA9PiB7XG4gICAgcmV0dXJuIHJ1blNRTChgXG4gICAgICBDUkVBVEUgU0VRVUVOQ0UgdGVzdGlkX3NlcVxuICAgICAgICBTVEFSVCBXSVRIIDFcbiAgICAgICAgSU5DUkVNRU5UIEJZIDFcbiAgICAgICAgTk8gTUlOVkFMVUVcbiAgICAgICAgTUFYVkFMVUUgMjE0NzQ4MzY0N1xuICAgICAgICBDQUNIRSAxXG4gICAgICAgIENZQ0xFO1xuICAgICAgQ1JFQVRFIFRBQkxFIHRlc3RzIChcbiAgICAgICAgaWQgaW50ZWdlciBub3QgbnVsbCBwcmltYXJ5IGtleSBERUZBVUxUIG5leHR2YWwoJ3Rlc3RpZF9zZXEnOjpyZWdjbGFzcyksXG4gICAgICAgIG5hbWUgdGV4dCxcbiAgICAgICAgXCJvdGhlck5hbWVcIiB0ZXh0LFxuICAgICAgICBleHRlbmRlZCBqc29uYiBub3QgbnVsbCBkZWZhdWx0ICd7fSc6Ompzb25iXG4gICAgICApO1xuICAgICAgQ1JFQVRFIFRBQkxFIHBhcmVudF9jaGlsZF9yZWxhdGlvbnNoaXAgKHBhcmVudF9pZCBpbnRlZ2VyIG5vdCBudWxsLCBjaGlsZF9pZCBpbnRlZ2VyIG5vdCBudWxsKTtcbiAgICAgIENSRUFURSBVTklRVUUgSU5ERVggY2hpbGRyZW5fam9pbiBvbiBwYXJlbnRfY2hpbGRfcmVsYXRpb25zaGlwIChwYXJlbnRfaWQsIGNoaWxkX2lkKTtcbiAgICAgIENSRUFURSBUQUJMRSB2YWxlbmNlX2NoaWxkcmVuIChwYXJlbnRfaWQgaW50ZWdlciBub3QgbnVsbCwgY2hpbGRfaWQgaW50ZWdlciBub3QgbnVsbCwgcGVybSBpbnRlZ2VyIG5vdCBudWxsKTtcbiAgICAgIENSRUFURSBVTklRVUUgSU5ERVggdmFsZW5jZV9jaGlsZHJlbl9qb2luIG9uIHZhbGVuY2VfY2hpbGRyZW4gKHBhcmVudF9pZCwgY2hpbGRfaWQpO1xuICAgICAgQ1JFQVRFIFRBQkxFIHF1ZXJ5X2NoaWxkcmVuIChwYXJlbnRfaWQgaW50ZWdlciBub3QgbnVsbCwgY2hpbGRfaWQgaW50ZWdlciBub3QgbnVsbCwgcGVybSBpbnRlZ2VyIG5vdCBudWxsKTtcbiAgICAgIENSRUFURSBVTklRVUUgSU5ERVggcXVlcnlfY2hpbGRyZW5fam9pbiBvbiBxdWVyeV9jaGlsZHJlbiAocGFyZW50X2lkLCBjaGlsZF9pZCk7XG4gICAgYCwgeyBkYXRhYmFzZTogbmFtZSB9KTtcbiAgfSk7XG59XG5cblxudGVzdFN1aXRlKHtcbiAgZGVzY3JpYmUsIGl0LCBiZWZvcmUsIGFmdGVyLFxufSwge1xuICBjdG9yOiBQR1N0b3JlLFxuICBvcHRzOiB7XG4gICAgc3FsOiB7XG4gICAgICBjb25uZWN0aW9uOiB7XG4gICAgICAgIGRhdGFiYXNlOiAncGx1bXBfdGVzdCcsXG4gICAgICAgIHVzZXI6ICdwb3N0Z3JlcycsXG4gICAgICAgIGhvc3Q6ICdsb2NhbGhvc3QnLFxuICAgICAgICBwb3J0OiA1NDMyLFxuICAgICAgfSxcbiAgICB9LFxuICAgIHRlcm1pbmFsOiB0cnVlLFxuICB9LFxuICBuYW1lOiAnUGx1bXAgUG9zdGdyZXMgU3RvcmUnLFxuICBiZWZvcmU6ICgpID0+IGNyZWF0ZURhdGFiYXNlKCdwbHVtcF90ZXN0JyksXG4gIGFmdGVyOiAoZHJpdmVyKSA9PiB7XG4gICAgcmV0dXJuIGRyaXZlci50ZWFyZG93bigpXG4gICAgLnRoZW4oKCkgPT4gcnVuU1FMKCdEUk9QIERBVEFCQVNFIHBsdW1wX3Rlc3Q7JykpO1xuICB9LFxufSk7XG5cbmNvbnN0IHNhbXBsZU9iamVjdDogSW5kZWZpbml0ZU1vZGVsRGF0YSA9IHtcbiAgdHlwZU5hbWU6ICd0ZXN0cycsXG4gIGF0dHJpYnV0ZXM6IHtcbiAgICBuYW1lOiAncG90YXRvJyxcbiAgICBvdGhlck5hbWU6ICdlbGVwaGFudGluZScsXG4gICAgZXh0ZW5kZWQ6IHtcbiAgICAgIGFjdHVhbDogJ3J1dGFiYWdhJyxcbiAgICAgIG90aGVyVmFsdWU6IDQyLFxuICAgIH0sXG4gIH0sXG59O1xuXG5kZXNjcmliZSgncG9zdGdyZXMtc3BlY2lmaWMgYmVoYXZpb3JzJywgKCkgPT4ge1xuICBsZXQgc3RvcmU6IFBHU3RvcmU7XG4gIGJlZm9yZSgoKSA9PiB7XG4gICAgcmV0dXJuIGNyZWF0ZURhdGFiYXNlKCdzZWNvbmRhcnlfcGx1bXBfdGVzdCcpXG4gICAgLnRoZW4oKCkgPT4ge1xuICAgICAgc3RvcmUgPSBuZXcgUEdTdG9yZSh7XG4gICAgICAgIHNxbDoge1xuICAgICAgICAgIGNvbm5lY3Rpb246IHtcbiAgICAgICAgICAgIGRhdGFiYXNlOiAnc2Vjb25kYXJ5X3BsdW1wX3Rlc3QnLFxuICAgICAgICAgICAgdXNlcjogJ3Bvc3RncmVzJyxcbiAgICAgICAgICAgIGhvc3Q6ICdsb2NhbGhvc3QnLFxuICAgICAgICAgICAgcG9ydDogNTQzMixcbiAgICAgICAgICB9LFxuICAgICAgICB9LFxuICAgICAgICB0ZXJtaW5hbDogdHJ1ZSxcbiAgICAgIH0pO1xuICAgICAgcmV0dXJuIHN0b3JlLmFkZFNjaGVtYShUZXN0VHlwZSk7XG4gICAgfSk7XG4gIH0pO1xuXG4gIGl0KCdSZXR1cm5zIGV4dHJhIGNvbnRlbnRzJywgKCkgPT4ge1xuICAgIHJldHVybiBzdG9yZS53cml0ZUF0dHJpYnV0ZXMoc2FtcGxlT2JqZWN0KVxuICAgIC50aGVuKChjcmVhdGVkT2JqZWN0KSA9PiB7XG4gICAgICByZXR1cm4gc3RvcmUud3JpdGVSZWxhdGlvbnNoaXBJdGVtKGNyZWF0ZWRPYmplY3QsICd2YWxlbmNlQ2hpbGRyZW4nLCB7IGlkOiAxMDAsIG1ldGE6IHsgcGVybTogMSB9IH0pXG4gICAgICAudGhlbigoKSA9PiBzdG9yZS53cml0ZVJlbGF0aW9uc2hpcEl0ZW0oY3JlYXRlZE9iamVjdCwgJ3F1ZXJ5Q2hpbGRyZW4nLCB7IGlkOiAxMDEsIG1ldGE6IHsgcGVybTogMSB9IH0pKVxuICAgICAgLnRoZW4oKCkgPT4gc3RvcmUud3JpdGVSZWxhdGlvbnNoaXBJdGVtKGNyZWF0ZWRPYmplY3QsICdxdWVyeUNoaWxkcmVuJywgeyBpZDogMTAyLCBtZXRhOiB7IHBlcm06IDIgfSB9KSlcbiAgICAgIC50aGVuKCgpID0+IHN0b3JlLndyaXRlUmVsYXRpb25zaGlwSXRlbShjcmVhdGVkT2JqZWN0LCAncXVlcnlDaGlsZHJlbicsIHsgaWQ6IDEwMywgbWV0YTogeyBwZXJtOiAzIH0gfSkpXG4gICAgICAudGhlbigoKSA9PiB7XG4gICAgICAgIGNvbnN0IHJlc3VsdE9iamVjdDogSW5kZWZpbml0ZU1vZGVsRGF0YSA9IG1lcmdlT3B0aW9ucyh7fSwgY3JlYXRlZE9iamVjdCwge1xuICAgICAgICAgIHJlbGF0aW9uc2hpcHM6IHtcbiAgICAgICAgICAgIHF1ZXJ5Q2hpbGRyZW46IFtcbiAgICAgICAgICAgICAgeyBpZDogMTAyLCBtZXRhOiB7IHBlcm06IDIgfSB9LFxuICAgICAgICAgICAgICB7IGlkOiAxMDMsIG1ldGE6IHsgcGVybTogMyB9IH0sXG4gICAgICAgICAgICBdLFxuICAgICAgICAgICAgcXVlcnlQYXJlbnRzOiBbXSxcbiAgICAgICAgICAgIHZhbGVuY2VDaGlsZHJlbjogW1xuICAgICAgICAgICAgICB7IGlkOiAxMDAsIG1ldGE6IHsgcGVybTogMSB9IH0sXG4gICAgICAgICAgICBdLFxuICAgICAgICAgICAgdmFsZW5jZVBhcmVudHM6IFtdLFxuICAgICAgICAgICAgY2hpbGRyZW46IFtdLFxuICAgICAgICAgICAgcGFyZW50czogW10sXG4gICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICAgICAgcmV0dXJuIHN0b3JlLnJlYWQoY3JlYXRlZE9iamVjdClcbiAgICAgICAgLnRoZW4oKHJlcykgPT4ge1xuICAgICAgICAgIHJldHVybiBleHBlY3QocmVzKS50by5kZWVwLmVxdWFsKHJlc3VsdE9iamVjdCk7XG4gICAgICAgIH0pO1xuICAgICAgfSk7XG4gICAgfSk7XG4gIH0pO1xuXG4gIGl0KCdzdXBwb3J0cyBhbGwgaGFzTWFueSByZWxhdGlvbnNoaXBzJywgKCkgPT4ge1xuICAgIHJldHVybiBzdG9yZS53cml0ZUF0dHJpYnV0ZXMoc2FtcGxlT2JqZWN0KVxuICAgIC50aGVuKChjcmVhdGVkT2JqZWN0KSA9PiB7XG4gICAgICByZXR1cm4gc3RvcmUud3JpdGVSZWxhdGlvbnNoaXBJdGVtKGNyZWF0ZWRPYmplY3QsICdxdWVyeUNoaWxkcmVuJywgeyBpZDogMTAxLCBtZXRhOiB7IHBlcm06IDEgfSB9KVxuICAgICAgLnRoZW4oKCkgPT4gc3RvcmUud3JpdGVSZWxhdGlvbnNoaXBJdGVtKGNyZWF0ZWRPYmplY3QsICdxdWVyeUNoaWxkcmVuJywgeyBpZDogMTAyLCBtZXRhOiB7IHBlcm06IDIgfSB9KSlcbiAgICAgIC50aGVuKCgpID0+IHN0b3JlLndyaXRlUmVsYXRpb25zaGlwSXRlbShjcmVhdGVkT2JqZWN0LCAncXVlcnlDaGlsZHJlbicsIHsgaWQ6IDEwMywgbWV0YTogeyBwZXJtOiAzIH0gfSkpXG4gICAgICAudGhlbigoKSA9PiBzdG9yZS53cml0ZVJlbGF0aW9uc2hpcEl0ZW0oY3JlYXRlZE9iamVjdCwgJ2NoaWxkcmVuJywgeyBpZDogMTAyIH0pKVxuICAgICAgLnRoZW4oKCkgPT4gc3RvcmUud3JpdGVSZWxhdGlvbnNoaXBJdGVtKGNyZWF0ZWRPYmplY3QsICdjaGlsZHJlbicsIHsgaWQ6IDEwMyB9KSlcbiAgICAgIC50aGVuKCgpID0+IHN0b3JlLndyaXRlUmVsYXRpb25zaGlwSXRlbShjcmVhdGVkT2JqZWN0LCAndmFsZW5jZUNoaWxkcmVuJywgeyBpZDogMTAyLCBtZXRhOiB7IHBlcm06IDIwIH0gfSkpXG4gICAgICAudGhlbigoKSA9PiBzdG9yZS53cml0ZVJlbGF0aW9uc2hpcEl0ZW0oY3JlYXRlZE9iamVjdCwgJ3ZhbGVuY2VDaGlsZHJlbicsIHsgaWQ6IDEwMywgbWV0YTogeyBwZXJtOiAzMCB9IH0pKVxuICAgICAgLnRoZW4oKCkgPT4gc3RvcmUucmVhZFJlbGF0aW9uc2hpcChjcmVhdGVkT2JqZWN0LCAncmVsYXRpb25zaGlwcy5xdWVyeUNoaWxkcmVuJykpXG4gICAgICAudGhlbigodikgPT4gZXhwZWN0KHYucmVsYXRpb25zaGlwcy5xdWVyeUNoaWxkcmVuKS50by5kZWVwLmVxdWFsKFxuICAgICAgICBbIHsgaWQ6IDEwMiwgbWV0YTogeyBwZXJtOiAyIH0gfSwgeyBpZDogMTAzLCBtZXRhOiB7IHBlcm06IDMgfSB9IF1cbiAgICAgICkpXG4gICAgICAudGhlbigoKSA9PiBzdG9yZS5yZWFkUmVsYXRpb25zaGlwKGNyZWF0ZWRPYmplY3QsICdyZWxhdGlvbnNoaXBzLmNoaWxkcmVuJykpXG4gICAgICAudGhlbigodikgPT4gZXhwZWN0KHYucmVsYXRpb25zaGlwcy5jaGlsZHJlbikudG8uZGVlcC5lcXVhbChcbiAgICAgICAgWyB7IGlkOiAxMDIgfSwgeyBpZDogMTAzIH0gXVxuICAgICAgKSlcbiAgICAgIC50aGVuKCgpID0+IHN0b3JlLnJlYWRSZWxhdGlvbnNoaXAoY3JlYXRlZE9iamVjdCwgJ3JlbGF0aW9uc2hpcHMudmFsZW5jZUNoaWxkcmVuJykpXG4gICAgICAudGhlbigodikgPT4gZXhwZWN0KHYucmVsYXRpb25zaGlwcy52YWxlbmNlQ2hpbGRyZW4pLnRvLmRlZXAuZXF1YWwoXG4gICAgICAgIFsgeyBpZDogMTAyLCBtZXRhOiB7IHBlcm06IDIwIH0gfSwgeyBpZDogMTAzLCBtZXRhOiB7IHBlcm06IDMwIH0gfSBdXG4gICAgICApKTtcbiAgICB9KTtcbiAgfSk7XG5cbiAgaXQoJ3JldHVybnMgbWFueSBvYmplY3RzIGluIGEgYnVsayBRdWVyeScsICgpID0+IHtcbiAgICByZXR1cm4gUHJvbWlzZS5hbGwoW1xuICAgICAgc3RvcmUud3JpdGVBdHRyaWJ1dGVzKHNhbXBsZU9iamVjdCksXG4gICAgICBzdG9yZS53cml0ZUF0dHJpYnV0ZXMoc2FtcGxlT2JqZWN0KSxcbiAgICAgIHN0b3JlLndyaXRlQXR0cmlidXRlcyhzYW1wbGVPYmplY3QpLFxuICAgICAgc3RvcmUud3JpdGVBdHRyaWJ1dGVzKHNhbXBsZU9iamVjdCksXG4gICAgICBzdG9yZS53cml0ZUF0dHJpYnV0ZXMoc2FtcGxlT2JqZWN0KSxcbiAgICBdKVxuICAgIC50aGVuKChjcmVhdGVkKSA9PiB7XG4gICAgICBjb25zdCBjcmVhdGVkT2JqZWN0ID0gY3JlYXRlZFswXTtcbiAgICAgIHJldHVybiBQcm9taXNlLmFsbChjcmVhdGVkLm1hcCgob2JqKSA9PiB7XG4gICAgICAgIHJldHVybiBQcm9taXNlLmFsbChbXG4gICAgICAgICAgc3RvcmUud3JpdGVSZWxhdGlvbnNoaXBJdGVtKG9iaiwgJ2NoaWxkcmVuJywgeyBpZDogKG9iai5pZCBhcyBudW1iZXIpICogMTAwICsgMSB9KSxcbiAgICAgICAgICBzdG9yZS53cml0ZVJlbGF0aW9uc2hpcEl0ZW0ob2JqLCAnY2hpbGRyZW4nLCB7IGlkOiAob2JqLmlkIGFzIG51bWJlcikgKiAxMDAgKyAyIH0pLFxuICAgICAgICAgIHN0b3JlLndyaXRlUmVsYXRpb25zaGlwSXRlbShvYmosICdjaGlsZHJlbicsIHsgaWQ6IChvYmouaWQgYXMgbnVtYmVyKSAqIDEwMCArIDMgfSksXG4gICAgICAgIF0pO1xuICAgICAgfSkpXG4gICAgICAudGhlbigoKSA9PiBzdG9yZS5idWxrUmVhZChjcmVhdGVkT2JqZWN0KSlcbiAgICAgIC50aGVuKChyZXMpID0+IHtcbiAgICAgICAgZXhwZWN0KHJlcykudG8uaGF2ZS5wcm9wZXJ0eSgnaW5jbHVkZWQnKS53aXRoLmxlbmd0aCg0KTtcbiAgICAgICAgcmVzLmluY2x1ZGVkLmZvckVhY2goKGkpID0+IHtcbiAgICAgICAgICBleHBlY3QoaS5yZWxhdGlvbnNoaXBzLmNoaWxkcmVuKS50by5kZWVwLmVxdWFsKFtcbiAgICAgICAgICAgIHsgaWQ6IGkuaWQgKiAxMDAgKyAxIH0sXG4gICAgICAgICAgICB7IGlkOiBpLmlkICogMTAwICsgMiB9LFxuICAgICAgICAgICAgeyBpZDogaS5pZCAqIDEwMCArIDMgfSxcbiAgICAgICAgICBdKTtcbiAgICAgICAgfSk7XG4gICAgICB9KTtcbiAgICB9KTtcbiAgfSk7XG5cbiAgYWZ0ZXIoKCkgPT4ge1xuICAgIHJldHVybiBzdG9yZS50ZWFyZG93bigpXG4gICAgLnRoZW4oKCkgPT4gcnVuU1FMKCdEUk9QIERBVEFCQVNFIHNlY29uZGFyeV9wbHVtcF90ZXN0OycpKTtcbiAgfSk7XG59KTtcbiJdfQ==
