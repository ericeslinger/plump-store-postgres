'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.blockRead = blockRead;
/* eslint prefer-template: 0*/

function deserializeWhereIntoJoin(query, block, joinName, fieldName, knex, Type) {
  // const car = block[0];
  // the query uses 'where', but we want to use 'on' instead
  var cdr = block.slice(1);
  if (Array.isArray(cdr[0])) {
    return cdr.reduce(function (subQuery, subBlock) {
      return deserializeWhereIntoJoin(subQuery, subBlock, joinName, fieldName, knex, Type);
    }, query);
  } else {
    cdr[0] = joinName + '.' + cdr[0];
    if (cdr[2] === '{id}') {
      cdr[2] = Type.$name + '.' + Type.$id;
    } else {
      cdr[2] = knex.raw('\'' + cdr[2] + '\'');
    }
    return query.on.apply(query, cdr);
  }
}

function blockRead(Type, knex, query) {
  var selects = [];
  var groups = [];
  var basicJoins = [];
  var fancyJoins = [];
  var schema = Type.$schema;
  for (var attrName in schema.attributes) {
    selects.push(attrName.toLowerCase());
    groups.push(attrName.toLowerCase());
  }
  for (var relName in schema.relationships) {
    var joinName = relName.toLowerCase();
    var rel = schema.relationships[relName].type;
    if (rel.$sides[relName].self.query) {
      fancyJoins.push({
        logic: rel.$sides[relName].self.query.logic,
        table: rel.$name + ' as ' + joinName,
        joinName: joinName,
        fieldName: rel.$sides[relName].other.field
      });
    } else {
      var joinBlock = {
        join: [rel.$name + ' as ' + joinName, joinName + '.' + rel.$sides[relName].self.field, '=', Type.$name + '.' + Type.$id],
        where: []
      };
      if (rel.$restrict) {
        for (var restriction in rel.$restrict) {
          joinBlock.where.push([joinName + '.' + restriction, '=', knex.raw('\'' + rel.$restrict[restriction].value + '\'')]);
        }
      }
      basicJoins.push(joinBlock);
    }
    var extraAgg = [];
    if (rel.$extras) {
      for (var extra in rel.$extras) {
        extraAgg.push('\'' + extra + '\'', joinName + '.' + extra);
      }
    }
    selects.push(knex.raw('COALESCE(\n        array_agg(\n          distinct(\n            jsonb_build_object(\n              \'' + rel.$sides[relName].other.field + '\', ' + joinName + '.' + rel.$sides[relName].other.field + ',\n              \'' + rel.$sides[relName].self.field + '\', ' + joinName + '.' + rel.$sides[relName].self.field + '\n              ' + (extraAgg.length ? ',' + extraAgg.join(',') : '') + '\n            )\n          )\n        )\n        FILTER (WHERE ' + joinName + '.' + rel.$sides[relName].other.field + ' IS NOT NULL),\n        \'{}\')\n      as ' + relName));
  }
  var joinedQuery = basicJoins.reduce(function (q, join) {
    return q.leftOuterJoin(join.join[0], function (qb) {
      qb.on(join.join[1], join.join[2], join.join[3]);
      join.where.forEach(function (where) {
        return qb.andOn.apply(qb, where);
      });
    });
  }, knex(Type.$name));

  var evenMoreJoinedQuery = fancyJoins.reduce(function (q, join) {
    return q.leftOuterJoin(join.table, function (qb) {
      return deserializeWhereIntoJoin(qb, join.logic, join.joinName, join.fieldName, knex, Type);
    });
  }, joinedQuery);
  var selectedQuery = evenMoreJoinedQuery.where(query).select(selects);
  var groupByQuery = selectedQuery.groupBy(groups);
  // console.log(groupByQuery.toString());
  return groupByQuery;
}
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImJsb2NrUmVhZC5qcyJdLCJuYW1lcyI6WyJibG9ja1JlYWQiLCJkZXNlcmlhbGl6ZVdoZXJlSW50b0pvaW4iLCJxdWVyeSIsImJsb2NrIiwiam9pbk5hbWUiLCJmaWVsZE5hbWUiLCJrbmV4IiwiVHlwZSIsImNkciIsInNsaWNlIiwiQXJyYXkiLCJpc0FycmF5IiwicmVkdWNlIiwic3ViUXVlcnkiLCJzdWJCbG9jayIsIiRuYW1lIiwiJGlkIiwicmF3Iiwib24iLCJhcHBseSIsInNlbGVjdHMiLCJncm91cHMiLCJiYXNpY0pvaW5zIiwiZmFuY3lKb2lucyIsInNjaGVtYSIsIiRzY2hlbWEiLCJhdHRyTmFtZSIsImF0dHJpYnV0ZXMiLCJwdXNoIiwidG9Mb3dlckNhc2UiLCJyZWxOYW1lIiwicmVsYXRpb25zaGlwcyIsInJlbCIsInR5cGUiLCIkc2lkZXMiLCJzZWxmIiwibG9naWMiLCJ0YWJsZSIsIm90aGVyIiwiZmllbGQiLCJqb2luQmxvY2siLCJqb2luIiwid2hlcmUiLCIkcmVzdHJpY3QiLCJyZXN0cmljdGlvbiIsInZhbHVlIiwiZXh0cmFBZ2ciLCIkZXh0cmFzIiwiZXh0cmEiLCJsZW5ndGgiLCJqb2luZWRRdWVyeSIsInEiLCJsZWZ0T3V0ZXJKb2luIiwicWIiLCJmb3JFYWNoIiwiYW5kT24iLCJldmVuTW9yZUpvaW5lZFF1ZXJ5Iiwic2VsZWN0ZWRRdWVyeSIsInNlbGVjdCIsImdyb3VwQnlRdWVyeSIsImdyb3VwQnkiXSwibWFwcGluZ3MiOiI7Ozs7O1FBc0JnQkEsUyxHQUFBQSxTO0FBdEJoQjs7QUFHQSxTQUFTQyx3QkFBVCxDQUFrQ0MsS0FBbEMsRUFBeUNDLEtBQXpDLEVBQWdEQyxRQUFoRCxFQUEwREMsU0FBMUQsRUFBcUVDLElBQXJFLEVBQTJFQyxJQUEzRSxFQUFpRjtBQUMvRTtBQUNBO0FBQ0EsTUFBTUMsTUFBTUwsTUFBTU0sS0FBTixDQUFZLENBQVosQ0FBWjtBQUNBLE1BQUlDLE1BQU1DLE9BQU4sQ0FBY0gsSUFBSSxDQUFKLENBQWQsQ0FBSixFQUEyQjtBQUN6QixXQUFPQSxJQUFJSSxNQUFKLENBQVcsVUFBQ0MsUUFBRCxFQUFXQyxRQUFYLEVBQXdCO0FBQ3hDLGFBQU9iLHlCQUF5QlksUUFBekIsRUFBbUNDLFFBQW5DLEVBQTZDVixRQUE3QyxFQUF1REMsU0FBdkQsRUFBa0VDLElBQWxFLEVBQXdFQyxJQUF4RSxDQUFQO0FBQ0QsS0FGTSxFQUVKTCxLQUZJLENBQVA7QUFHRCxHQUpELE1BSU87QUFDTE0sUUFBSSxDQUFKLElBQVlKLFFBQVosU0FBd0JJLElBQUksQ0FBSixDQUF4QjtBQUNBLFFBQUlBLElBQUksQ0FBSixNQUFXLE1BQWYsRUFBdUI7QUFDckJBLFVBQUksQ0FBSixJQUFZRCxLQUFLUSxLQUFqQixTQUEwQlIsS0FBS1MsR0FBL0I7QUFDRCxLQUZELE1BRU87QUFDTFIsVUFBSSxDQUFKLElBQVNGLEtBQUtXLEdBQUwsUUFBYVQsSUFBSSxDQUFKLENBQWIsUUFBVDtBQUNEO0FBQ0QsV0FBT04sTUFBTWdCLEVBQU4sQ0FBU0MsS0FBVCxDQUFlakIsS0FBZixFQUFzQk0sR0FBdEIsQ0FBUDtBQUNEO0FBQ0Y7O0FBRU0sU0FBU1IsU0FBVCxDQUFtQk8sSUFBbkIsRUFBeUJELElBQXpCLEVBQStCSixLQUEvQixFQUFzQztBQUMzQyxNQUFNa0IsVUFBVSxFQUFoQjtBQUNBLE1BQU1DLFNBQVMsRUFBZjtBQUNBLE1BQU1DLGFBQWEsRUFBbkI7QUFDQSxNQUFNQyxhQUFhLEVBQW5CO0FBQ0EsTUFBTUMsU0FBU2pCLEtBQUtrQixPQUFwQjtBQUNBLE9BQUssSUFBTUMsUUFBWCxJQUF1QkYsT0FBT0csVUFBOUIsRUFBMEM7QUFDeENQLFlBQVFRLElBQVIsQ0FBYUYsU0FBU0csV0FBVCxFQUFiO0FBQ0FSLFdBQU9PLElBQVAsQ0FBWUYsU0FBU0csV0FBVCxFQUFaO0FBQ0Q7QUFDRCxPQUFLLElBQU1DLE9BQVgsSUFBc0JOLE9BQU9PLGFBQTdCLEVBQTRDO0FBQzFDLFFBQU0zQixXQUFXMEIsUUFBUUQsV0FBUixFQUFqQjtBQUNBLFFBQU1HLE1BQU1SLE9BQU9PLGFBQVAsQ0FBcUJELE9BQXJCLEVBQThCRyxJQUExQztBQUNBLFFBQUlELElBQUlFLE1BQUosQ0FBV0osT0FBWCxFQUFvQkssSUFBcEIsQ0FBeUJqQyxLQUE3QixFQUFvQztBQUNsQ3FCLGlCQUFXSyxJQUFYLENBQWdCO0FBQ2RRLGVBQU9KLElBQUlFLE1BQUosQ0FBV0osT0FBWCxFQUFvQkssSUFBcEIsQ0FBeUJqQyxLQUF6QixDQUErQmtDLEtBRHhCO0FBRWRDLGVBQVVMLElBQUlqQixLQUFkLFlBQTBCWCxRQUZaO0FBR2RBLGtCQUFVQSxRQUhJO0FBSWRDLG1CQUFXMkIsSUFBSUUsTUFBSixDQUFXSixPQUFYLEVBQW9CUSxLQUFwQixDQUEwQkM7QUFKdkIsT0FBaEI7QUFNRCxLQVBELE1BT087QUFDTCxVQUFNQyxZQUFZO0FBQ2hCQyxjQUFNLENBQ0RULElBQUlqQixLQURILFlBQ2VYLFFBRGYsRUFFREEsUUFGQyxTQUVXNEIsSUFBSUUsTUFBSixDQUFXSixPQUFYLEVBQW9CSyxJQUFwQixDQUF5QkksS0FGcEMsRUFHSixHQUhJLEVBSURoQyxLQUFLUSxLQUpKLFNBSWFSLEtBQUtTLEdBSmxCLENBRFU7QUFPaEIwQixlQUFPO0FBUFMsT0FBbEI7QUFTQSxVQUFJVixJQUFJVyxTQUFSLEVBQW1CO0FBQ2pCLGFBQUssSUFBTUMsV0FBWCxJQUEwQlosSUFBSVcsU0FBOUIsRUFBeUM7QUFDdkNILG9CQUFVRSxLQUFWLENBQWdCZCxJQUFoQixDQUNFLENBQUl4QixRQUFKLFNBQWdCd0MsV0FBaEIsRUFBK0IsR0FBL0IsRUFBb0N0QyxLQUFLVyxHQUFMLFFBQWFlLElBQUlXLFNBQUosQ0FBY0MsV0FBZCxFQUEyQkMsS0FBeEMsUUFBcEMsQ0FERjtBQUdEO0FBQ0Y7QUFDRHZCLGlCQUFXTSxJQUFYLENBQWdCWSxTQUFoQjtBQUNEO0FBQ0QsUUFBTU0sV0FBVyxFQUFqQjtBQUNBLFFBQUlkLElBQUllLE9BQVIsRUFBaUI7QUFDZixXQUFLLElBQU1DLEtBQVgsSUFBb0JoQixJQUFJZSxPQUF4QixFQUFpQztBQUMvQkQsaUJBQVNsQixJQUFULFFBQWtCb0IsS0FBbEIsU0FBK0I1QyxRQUEvQixTQUEyQzRDLEtBQTNDO0FBQ0Q7QUFDRjtBQUNENUIsWUFBUVEsSUFBUixDQUFhdEIsS0FBS1csR0FBTCwyR0FLQWUsSUFBSUUsTUFBSixDQUFXSixPQUFYLEVBQW9CUSxLQUFwQixDQUEwQkMsS0FMMUIsWUFLcUNuQyxRQUxyQyxTQUtpRDRCLElBQUlFLE1BQUosQ0FBV0osT0FBWCxFQUFvQlEsS0FBcEIsQ0FBMEJDLEtBTDNFLDJCQU1BUCxJQUFJRSxNQUFKLENBQVdKLE9BQVgsRUFBb0JLLElBQXBCLENBQXlCSSxLQU56QixZQU1vQ25DLFFBTnBDLFNBTWdENEIsSUFBSUUsTUFBSixDQUFXSixPQUFYLEVBQW9CSyxJQUFwQixDQUF5QkksS0FOekUseUJBT0RPLFNBQVNHLE1BQVQsR0FBa0IsTUFBTUgsU0FBU0wsSUFBVCxDQUFjLEdBQWQsQ0FBeEIsR0FBNkMsRUFQNUMsd0VBV09yQyxRQVhQLFNBV21CNEIsSUFBSUUsTUFBSixDQUFXSixPQUFYLEVBQW9CUSxLQUFwQixDQUEwQkMsS0FYN0Msa0RBYU5ULE9BYk0sQ0FBYjtBQWVEO0FBQ0QsTUFBTW9CLGNBQWM1QixXQUFXVixNQUFYLENBQWtCLFVBQUN1QyxDQUFELEVBQUlWLElBQUosRUFBYTtBQUNqRCxXQUFPVSxFQUFFQyxhQUFGLENBQWdCWCxLQUFLQSxJQUFMLENBQVUsQ0FBVixDQUFoQixFQUE4QixVQUFDWSxFQUFELEVBQVE7QUFDM0NBLFNBQUduQyxFQUFILENBQU11QixLQUFLQSxJQUFMLENBQVUsQ0FBVixDQUFOLEVBQW9CQSxLQUFLQSxJQUFMLENBQVUsQ0FBVixDQUFwQixFQUFrQ0EsS0FBS0EsSUFBTCxDQUFVLENBQVYsQ0FBbEM7QUFDQUEsV0FBS0MsS0FBTCxDQUFXWSxPQUFYLENBQW1CLFVBQUNaLEtBQUQ7QUFBQSxlQUFXVyxHQUFHRSxLQUFILENBQVNwQyxLQUFULENBQWVrQyxFQUFmLEVBQW1CWCxLQUFuQixDQUFYO0FBQUEsT0FBbkI7QUFDRCxLQUhNLENBQVA7QUFJRCxHQUxtQixFQUtqQnBDLEtBQUtDLEtBQUtRLEtBQVYsQ0FMaUIsQ0FBcEI7O0FBT0EsTUFBTXlDLHNCQUFzQmpDLFdBQVdYLE1BQVgsQ0FBa0IsVUFBQ3VDLENBQUQsRUFBSVYsSUFBSixFQUFhO0FBQ3pELFdBQU9VLEVBQUVDLGFBQUYsQ0FBZ0JYLEtBQUtKLEtBQXJCLEVBQTRCLFVBQUNnQixFQUFELEVBQVE7QUFDekMsYUFBT3BELHlCQUF5Qm9ELEVBQXpCLEVBQTZCWixLQUFLTCxLQUFsQyxFQUF5Q0ssS0FBS3JDLFFBQTlDLEVBQXdEcUMsS0FBS3BDLFNBQTdELEVBQXdFQyxJQUF4RSxFQUE4RUMsSUFBOUUsQ0FBUDtBQUNELEtBRk0sQ0FBUDtBQUdELEdBSjJCLEVBSXpCMkMsV0FKeUIsQ0FBNUI7QUFLQSxNQUFNTyxnQkFBZ0JELG9CQUFvQmQsS0FBcEIsQ0FBMEJ4QyxLQUExQixFQUFpQ3dELE1BQWpDLENBQXdDdEMsT0FBeEMsQ0FBdEI7QUFDQSxNQUFNdUMsZUFBZUYsY0FBY0csT0FBZCxDQUFzQnZDLE1BQXRCLENBQXJCO0FBQ0E7QUFDQSxTQUFPc0MsWUFBUDtBQUNEIiwiZmlsZSI6ImJsb2NrUmVhZC5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8qIGVzbGludCBwcmVmZXItdGVtcGxhdGU6IDAqL1xuXG5cbmZ1bmN0aW9uIGRlc2VyaWFsaXplV2hlcmVJbnRvSm9pbihxdWVyeSwgYmxvY2ssIGpvaW5OYW1lLCBmaWVsZE5hbWUsIGtuZXgsIFR5cGUpIHtcbiAgLy8gY29uc3QgY2FyID0gYmxvY2tbMF07XG4gIC8vIHRoZSBxdWVyeSB1c2VzICd3aGVyZScsIGJ1dCB3ZSB3YW50IHRvIHVzZSAnb24nIGluc3RlYWRcbiAgY29uc3QgY2RyID0gYmxvY2suc2xpY2UoMSk7XG4gIGlmIChBcnJheS5pc0FycmF5KGNkclswXSkpIHtcbiAgICByZXR1cm4gY2RyLnJlZHVjZSgoc3ViUXVlcnksIHN1YkJsb2NrKSA9PiB7XG4gICAgICByZXR1cm4gZGVzZXJpYWxpemVXaGVyZUludG9Kb2luKHN1YlF1ZXJ5LCBzdWJCbG9jaywgam9pbk5hbWUsIGZpZWxkTmFtZSwga25leCwgVHlwZSk7XG4gICAgfSwgcXVlcnkpO1xuICB9IGVsc2Uge1xuICAgIGNkclswXSA9IGAke2pvaW5OYW1lfS4ke2NkclswXX1gO1xuICAgIGlmIChjZHJbMl0gPT09ICd7aWR9Jykge1xuICAgICAgY2RyWzJdID0gYCR7VHlwZS4kbmFtZX0uJHtUeXBlLiRpZH1gO1xuICAgIH0gZWxzZSB7XG4gICAgICBjZHJbMl0gPSBrbmV4LnJhdyhgJyR7Y2RyWzJdfSdgKTtcbiAgICB9XG4gICAgcmV0dXJuIHF1ZXJ5Lm9uLmFwcGx5KHF1ZXJ5LCBjZHIpO1xuICB9XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBibG9ja1JlYWQoVHlwZSwga25leCwgcXVlcnkpIHtcbiAgY29uc3Qgc2VsZWN0cyA9IFtdO1xuICBjb25zdCBncm91cHMgPSBbXTtcbiAgY29uc3QgYmFzaWNKb2lucyA9IFtdO1xuICBjb25zdCBmYW5jeUpvaW5zID0gW107XG4gIGNvbnN0IHNjaGVtYSA9IFR5cGUuJHNjaGVtYTtcbiAgZm9yIChjb25zdCBhdHRyTmFtZSBpbiBzY2hlbWEuYXR0cmlidXRlcykge1xuICAgIHNlbGVjdHMucHVzaChhdHRyTmFtZS50b0xvd2VyQ2FzZSgpKTtcbiAgICBncm91cHMucHVzaChhdHRyTmFtZS50b0xvd2VyQ2FzZSgpKTtcbiAgfVxuICBmb3IgKGNvbnN0IHJlbE5hbWUgaW4gc2NoZW1hLnJlbGF0aW9uc2hpcHMpIHtcbiAgICBjb25zdCBqb2luTmFtZSA9IHJlbE5hbWUudG9Mb3dlckNhc2UoKTtcbiAgICBjb25zdCByZWwgPSBzY2hlbWEucmVsYXRpb25zaGlwc1tyZWxOYW1lXS50eXBlO1xuICAgIGlmIChyZWwuJHNpZGVzW3JlbE5hbWVdLnNlbGYucXVlcnkpIHtcbiAgICAgIGZhbmN5Sm9pbnMucHVzaCh7XG4gICAgICAgIGxvZ2ljOiByZWwuJHNpZGVzW3JlbE5hbWVdLnNlbGYucXVlcnkubG9naWMsXG4gICAgICAgIHRhYmxlOiBgJHtyZWwuJG5hbWV9IGFzICR7am9pbk5hbWV9YCxcbiAgICAgICAgam9pbk5hbWU6IGpvaW5OYW1lLFxuICAgICAgICBmaWVsZE5hbWU6IHJlbC4kc2lkZXNbcmVsTmFtZV0ub3RoZXIuZmllbGQsXG4gICAgICB9KTtcbiAgICB9IGVsc2Uge1xuICAgICAgY29uc3Qgam9pbkJsb2NrID0ge1xuICAgICAgICBqb2luOiBbXG4gICAgICAgICAgYCR7cmVsLiRuYW1lfSBhcyAke2pvaW5OYW1lfWAsXG4gICAgICAgICAgYCR7am9pbk5hbWV9LiR7cmVsLiRzaWRlc1tyZWxOYW1lXS5zZWxmLmZpZWxkfWAsXG4gICAgICAgICAgJz0nLFxuICAgICAgICAgIGAke1R5cGUuJG5hbWV9LiR7VHlwZS4kaWR9YCxcbiAgICAgICAgXSxcbiAgICAgICAgd2hlcmU6IFtdLFxuICAgICAgfTtcbiAgICAgIGlmIChyZWwuJHJlc3RyaWN0KSB7XG4gICAgICAgIGZvciAoY29uc3QgcmVzdHJpY3Rpb24gaW4gcmVsLiRyZXN0cmljdCkge1xuICAgICAgICAgIGpvaW5CbG9jay53aGVyZS5wdXNoKFxuICAgICAgICAgICAgW2Ake2pvaW5OYW1lfS4ke3Jlc3RyaWN0aW9ufWAsICc9Jywga25leC5yYXcoYCcke3JlbC4kcmVzdHJpY3RbcmVzdHJpY3Rpb25dLnZhbHVlfSdgKV1cbiAgICAgICAgICApO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgICBiYXNpY0pvaW5zLnB1c2goam9pbkJsb2NrKTtcbiAgICB9XG4gICAgY29uc3QgZXh0cmFBZ2cgPSBbXTtcbiAgICBpZiAocmVsLiRleHRyYXMpIHtcbiAgICAgIGZvciAoY29uc3QgZXh0cmEgaW4gcmVsLiRleHRyYXMpIHtcbiAgICAgICAgZXh0cmFBZ2cucHVzaChgJyR7ZXh0cmF9J2AsIGAke2pvaW5OYW1lfS4ke2V4dHJhfWApO1xuICAgICAgfVxuICAgIH1cbiAgICBzZWxlY3RzLnB1c2goa25leC5yYXcoXG4gICAgICBgQ09BTEVTQ0UoXG4gICAgICAgIGFycmF5X2FnZyhcbiAgICAgICAgICBkaXN0aW5jdChcbiAgICAgICAgICAgIGpzb25iX2J1aWxkX29iamVjdChcbiAgICAgICAgICAgICAgJyR7cmVsLiRzaWRlc1tyZWxOYW1lXS5vdGhlci5maWVsZH0nLCAke2pvaW5OYW1lfS4ke3JlbC4kc2lkZXNbcmVsTmFtZV0ub3RoZXIuZmllbGR9LFxuICAgICAgICAgICAgICAnJHtyZWwuJHNpZGVzW3JlbE5hbWVdLnNlbGYuZmllbGR9JywgJHtqb2luTmFtZX0uJHtyZWwuJHNpZGVzW3JlbE5hbWVdLnNlbGYuZmllbGR9XG4gICAgICAgICAgICAgICR7ZXh0cmFBZ2cubGVuZ3RoID8gJywnICsgZXh0cmFBZ2cuam9pbignLCcpIDogJyd9XG4gICAgICAgICAgICApXG4gICAgICAgICAgKVxuICAgICAgICApXG4gICAgICAgIEZJTFRFUiAoV0hFUkUgJHtqb2luTmFtZX0uJHtyZWwuJHNpZGVzW3JlbE5hbWVdLm90aGVyLmZpZWxkfSBJUyBOT1QgTlVMTCksXG4gICAgICAgICd7fScpXG4gICAgICBhcyAke3JlbE5hbWV9YFxuICAgICkpO1xuICB9XG4gIGNvbnN0IGpvaW5lZFF1ZXJ5ID0gYmFzaWNKb2lucy5yZWR1Y2UoKHEsIGpvaW4pID0+IHtcbiAgICByZXR1cm4gcS5sZWZ0T3V0ZXJKb2luKGpvaW4uam9pblswXSwgKHFiKSA9PiB7XG4gICAgICBxYi5vbihqb2luLmpvaW5bMV0sIGpvaW4uam9pblsyXSwgam9pbi5qb2luWzNdKTtcbiAgICAgIGpvaW4ud2hlcmUuZm9yRWFjaCgod2hlcmUpID0+IHFiLmFuZE9uLmFwcGx5KHFiLCB3aGVyZSkpO1xuICAgIH0pO1xuICB9LCBrbmV4KFR5cGUuJG5hbWUpKTtcblxuICBjb25zdCBldmVuTW9yZUpvaW5lZFF1ZXJ5ID0gZmFuY3lKb2lucy5yZWR1Y2UoKHEsIGpvaW4pID0+IHtcbiAgICByZXR1cm4gcS5sZWZ0T3V0ZXJKb2luKGpvaW4udGFibGUsIChxYikgPT4ge1xuICAgICAgcmV0dXJuIGRlc2VyaWFsaXplV2hlcmVJbnRvSm9pbihxYiwgam9pbi5sb2dpYywgam9pbi5qb2luTmFtZSwgam9pbi5maWVsZE5hbWUsIGtuZXgsIFR5cGUpO1xuICAgIH0pO1xuICB9LCBqb2luZWRRdWVyeSk7XG4gIGNvbnN0IHNlbGVjdGVkUXVlcnkgPSBldmVuTW9yZUpvaW5lZFF1ZXJ5LndoZXJlKHF1ZXJ5KS5zZWxlY3Qoc2VsZWN0cyk7XG4gIGNvbnN0IGdyb3VwQnlRdWVyeSA9IHNlbGVjdGVkUXVlcnkuZ3JvdXBCeShncm91cHMpO1xuICAvLyBjb25zb2xlLmxvZyhncm91cEJ5UXVlcnkudG9TdHJpbmcoKSk7XG4gIHJldHVybiBncm91cEJ5UXVlcnk7XG59XG4iXX0=
