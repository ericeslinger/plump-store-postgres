'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.blockRead = blockRead;
/* eslint prefer-template: 0*/

function deserializeWhereIntoJoin(query, block, joinName, fieldName, knex, Type) {
  // const car = block[0];
  // the query uses 'where', but we want to use 'on' instead
  var cdr = block.slice(1);
  if (Array.isArray(cdr[0])) {
    return cdr.reduce(function (subQuery, subBlock) {
      return deserializeWhereIntoJoin(subQuery, subBlock, joinName, fieldName, knex, Type);
    }, query);
  } else {
    cdr[0] = joinName + '.' + cdr[0];
    if (cdr[2] === '{id}') {
      cdr[2] = Type.$name + '.' + Type.$id;
    } else {
      cdr[2] = knex.raw('\'' + cdr[2] + '\'');
    }
    return query.on.apply(query, cdr);
  }
}

function blockRead(Type, knex, query) {
  var selects = [];
  var groups = [];
  var basicJoins = [];
  var fancyJoins = [];
  var schema = Type.$schema;
  Object.keys(schema).forEach(function (key) {
    if (schema[key].type === 'hasMany') {
      var joinName = key.toLowerCase();
      var rel = schema[key].relationship;
      if (rel.$sides[key].self.query) {
        fancyJoins.push({
          logic: rel.$sides[key].self.query.logic,
          table: rel.$name + ' as ' + joinName,
          joinName: joinName,
          fieldName: rel.$sides[key].other.field
        });
      } else {
        var joinBlock = {
          join: [rel.$name + ' as ' + joinName, joinName + '.' + rel.$sides[key].self.field, '=', Type.$name + '.' + Type.$id],
          where: []
        };
        if (rel.$restrict) {
          Object.keys(rel.$restrict).forEach(function (restriction) {
            joinBlock.where.push([joinName + '.' + restriction, '=', knex.raw('\'' + rel.$restrict[restriction].value + '\'')]);
          });
        }
        basicJoins.push(joinBlock);
      }
      var extraAgg = [];
      if (rel.$extras) {
        Object.keys(rel.$extras).forEach(function (extra) {
          extraAgg.push('\'' + extra + '\'', joinName + '.' + extra);
        });
      }
      selects.push(knex.raw('COALESCE(\n          array_agg(\n            distinct(\n              jsonb_build_object(\n                \'id\', ' + joinName + '.' + rel.$sides[key].other.field + '\n                ' + (extraAgg.length ? ',' + extraAgg.join(',') : '') + '\n              )\n            )\n          )\n          FILTER (WHERE ' + joinName + '.' + rel.$sides[key].other.field + ' IS NOT NULL),\n          \'{}\')\n        as ' + key));
    } else {
      selects.push(key);
      groups.push(key);
    }
  });
  var joinedQuery = basicJoins.reduce(function (q, join) {
    return q.leftOuterJoin(join.join[0], function (qb) {
      qb.on(join.join[1], join.join[2], join.join[3]);
      join.where.forEach(function (where) {
        return qb.andOn.apply(qb, where);
      });
    });
  }, knex(Type.$name));

  var evenMoreJoinedQuery = fancyJoins.reduce(function (q, join) {
    return q.leftOuterJoin(join.table, function (qb) {
      return deserializeWhereIntoJoin(qb, join.logic, join.joinName, join.fieldName, knex, Type);
    });
  }, joinedQuery);
  var selectedQuery = evenMoreJoinedQuery.where(query).select(selects);
  var groupByQuery = selectedQuery.groupBy(groups);
  // console.log(groupByQuery.toString());
  return groupByQuery;
}
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImJsb2NrUmVhZC5qcyJdLCJuYW1lcyI6WyJibG9ja1JlYWQiLCJkZXNlcmlhbGl6ZVdoZXJlSW50b0pvaW4iLCJxdWVyeSIsImJsb2NrIiwiam9pbk5hbWUiLCJmaWVsZE5hbWUiLCJrbmV4IiwiVHlwZSIsImNkciIsInNsaWNlIiwiQXJyYXkiLCJpc0FycmF5IiwicmVkdWNlIiwic3ViUXVlcnkiLCJzdWJCbG9jayIsIiRuYW1lIiwiJGlkIiwicmF3Iiwib24iLCJhcHBseSIsInNlbGVjdHMiLCJncm91cHMiLCJiYXNpY0pvaW5zIiwiZmFuY3lKb2lucyIsInNjaGVtYSIsIiRmaWVsZHMiLCJPYmplY3QiLCJrZXlzIiwiZm9yRWFjaCIsImtleSIsInR5cGUiLCJ0b0xvd2VyQ2FzZSIsInJlbCIsInJlbGF0aW9uc2hpcCIsIiRzaWRlcyIsInNlbGYiLCJwdXNoIiwibG9naWMiLCJ0YWJsZSIsIm90aGVyIiwiZmllbGQiLCJqb2luQmxvY2siLCJqb2luIiwid2hlcmUiLCIkcmVzdHJpY3QiLCJyZXN0cmljdGlvbiIsInZhbHVlIiwiZXh0cmFBZ2ciLCIkZXh0cmFzIiwiZXh0cmEiLCJsZW5ndGgiLCJqb2luZWRRdWVyeSIsInEiLCJsZWZ0T3V0ZXJKb2luIiwicWIiLCJhbmRPbiIsImV2ZW5Nb3JlSm9pbmVkUXVlcnkiLCJzZWxlY3RlZFF1ZXJ5Iiwic2VsZWN0IiwiZ3JvdXBCeVF1ZXJ5IiwiZ3JvdXBCeSJdLCJtYXBwaW5ncyI6Ijs7Ozs7UUFzQmdCQSxTLEdBQUFBLFM7QUF0QmhCOztBQUdBLFNBQVNDLHdCQUFULENBQWtDQyxLQUFsQyxFQUF5Q0MsS0FBekMsRUFBZ0RDLFFBQWhELEVBQTBEQyxTQUExRCxFQUFxRUMsSUFBckUsRUFBMkVDLElBQTNFLEVBQWlGO0FBQy9FO0FBQ0E7QUFDQSxNQUFNQyxNQUFNTCxNQUFNTSxLQUFOLENBQVksQ0FBWixDQUFaO0FBQ0EsTUFBSUMsTUFBTUMsT0FBTixDQUFjSCxJQUFJLENBQUosQ0FBZCxDQUFKLEVBQTJC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Q0FBa0IsVUFBQ3dDLENBQUQsRUFBSVYsSUFBSixFQUFhO0FBQ3pELFdBQU9VLEVBQUVDLGFBQUYsQ0FBZ0JYLEtBQUtKLEtBQXJCLEVBQTRCLFVBQUNnQixFQUFELEVBQVE7QUFDekMsYUFBT3JELHlCQUF5QnFELEVBQXpCLEVBQTZCWixLQUFLTCxLQUFsQyxFQUF5Q0ssS0FBS3RDLFFBQTlDLEVBQXdEc0MsS0FBS3JDLFNBQTdELEVBQXdFQyxJQUF4RSxFQUE4RUMsSUFBOUUsQ0FBUDtBQUNELEtBRk0sQ0FBUDtBQUdELEdBSjJCLEVBSXpCNEMsV0FKeUIsQ0FBNUI7QUFLQSxNQUFNTSxnQkFBZ0JELG9CQUFvQmIsS0FBcEIsQ0FBMEJ6QyxLQUExQixFQUFpQ3dELE1BQWpDLENBQXdDdEMsT0FBeEMsQ0FBdEI7QUFDQSxNQUFNdUMsZUFBZUYsY0FBY0csT0FBZCxDQUFzQnZDLE1BQXRCLENBQXJCO0FBQ0E7QUFDQSxTQUFPc0MsWUFBUDtBQUNEIiwiZmlsZSI6ImJsb2NrUmVhZC5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8qIGVzbGludCBwcmVmZXItdGVtcGxhdGU6IDAqL1xuXG5cbmZ1bmN0aW9uIGRlc2VyaWFsaXplV2hlcmVJbnRvSm9pbihxdWVyeSwgYmxvY2ssIGpvaW5OYW1lLCBmaWVsZE5hbWUsIGtuZXgsIFR5cGUpIHtcbiAgLy8gY29uc3QgY2FyID0gYmxvY2tbMF07XG4gIC8vIHRoZSBxdWVyeSB1c2VzICd3aGVyZScsIGJ1dCB3ZSB3YW50IHRvIHVzZSAnb24nIGluc3RlYWRcbiAgY29uc3QgY2RyID0gYmxvY2suc2xpY2UoMSk7XG4gIGlmIChBcnJheS5pc0FycmF5KGNkclswXSkpIHtcbiAgICByZXR1cm4gY2RyLnJlZHVjZSgoc3ViUXVlcnksIHN1YkJsb2NrKSA9PiB7XG4gICAgICByZXR1cm4gZGVzZXJpYWxpemVXaGVyZUludG9Kb2luKHN1YlF1ZXJ5LCBzdWJCbG9jaywgam9pbk5hbWUsIGZpZWxkTmFtZSwga25leCwgVHlwZSk7XG4gICAgfSwgcXVlcnkpO1xuICB9IGVsc2Uge1xuICAgIGNkclswXSA9IGAke2pvaW5OYW1lfS4ke2NkclswXX1gO1xuICAgIGlmIChjZHJbMl0gPT09ICd7aWR9Jykge1xuICAgICAgY2RyWzJdID0gYCR7VHlwZS4kbmFtZX0uJHtUeXBlLiRpZH1gO1xuICAgIH0gZWxzZSB7XG4gICAgICBjZHJbMl0gPSBrbmV4LnJhdyhgJyR7Y2RyWzJdfSdgKTtcbiAgICB9XG4gICAgcmV0dXJuIHF1ZXJ5Lm9uLmFwcGx5KHF1ZXJ5LCBjZHIpO1xuICB9XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBibG9ja1JlYWQoVHlwZSwga25leCwgcXVlcnkpIHtcbiAgY29uc3Qgc2VsZWN0cyA9IFtdO1xuICBjb25zdCBncm91cHMgPSBbXTtcbiAgY29uc3QgYmFzaWNKb2lucyA9IFtdO1xuICBjb25zdCBmYW5jeUpvaW5zID0gW107XG4gIGNvbnN0IHNjaGVtYSA9IFR5cGUuJGZpZWxkcztcbiAgT2JqZWN0LmtleXMoc2NoZW1hKS5mb3JFYWNoKChrZXkpID0+IHtcbiAgICBpZiAoc2NoZW1hW2tleV0udHlwZSA9PT0gJ2hhc01hbnknKSB7XG4gICAgICBjb25zdCBqb2luTmFtZSA9IGtleS50b0xvd2VyQ2FzZSgpO1xuICAgICAgY29uc3QgcmVsID0gc2NoZW1hW2tleV0ucmVsYXRpb25zaGlwO1xuICAgICAgaWYgKHJlbC4kc2lkZXNba2V5XS5zZWxmLnF1ZXJ5KSB7XG4gICAgICAgIGZhbmN5Sm9pbnMucHVzaCh7XG4gICAgICAgICAgbG9naWM6IHJlbC4kc2lkZXNba2V5XS5zZWxmLnF1ZXJ5LmxvZ2ljLFxuICAgICAgICAgIHRhYmxlOiBgJHtyZWwuJG5hbWV9IGFzICR7am9pbk5hbWV9YCxcbiAgICAgICAgICBqb2luTmFtZTogam9pbk5hbWUsXG4gICAgICAgICAgZmllbGROYW1lOiByZWwuJHNpZGVzW2tleV0ub3RoZXIuZmllbGQsXG4gICAgICAgIH0pO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgY29uc3Qgam9pbkJsb2NrID0ge1xuICAgICAgICAgIGpvaW46IFtcbiAgICAgICAgICAgIGAke3JlbC4kbmFtZX0gYXMgJHtqb2luTmFtZX1gLFxuICAgICAgICAgICAgYCR7am9pbk5hbWV9LiR7cmVsLiRzaWRlc1trZXldLnNlbGYuZmllbGR9YCxcbiAgICAgICAgICAgICc9JyxcbiAgICAgICAgICAgIGAke1R5cGUuJG5hbWV9LiR7VHlwZS4kaWR9YCxcbiAgICAgICAgICBdLFxuICAgICAgICAgIHdoZXJlOiBbXSxcbiAgICAgICAgfTtcbiAgICAgICAgaWYgKHJlbC4kcmVzdHJpY3QpIHtcbiAgICAgICAgICBPYmplY3Qua2V5cyhyZWwuJHJlc3RyaWN0KS5mb3JFYWNoKChyZXN0cmljdGlvbikgPT4ge1xuICAgICAgICAgICAgam9pbkJsb2NrLndoZXJlLnB1c2goXG4gICAgICAgICAgICAgIFtgJHtqb2luTmFtZX0uJHtyZXN0cmljdGlvbn1gLCAnPScsIGtuZXgucmF3KGAnJHtyZWwuJHJlc3RyaWN0W3Jlc3RyaWN0aW9uXS52YWx1ZX0nYCldXG4gICAgICAgICAgICApO1xuICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgICAgIGJhc2ljSm9pbnMucHVzaChqb2luQmxvY2spO1xuICAgICAgfVxuICAgICAgY29uc3QgZXh0cmFBZ2cgPSBbXTtcbiAgICAgIGlmIChyZWwuJGV4dHJhcykge1xuICAgICAgICBPYmplY3Qua2V5cyhyZWwuJGV4dHJhcykuZm9yRWFjaCgoZXh0cmEpID0+IHtcbiAgICAgICAgICBleHRyYUFnZy5wdXNoKGAnJHtleHRyYX0nYCwgYCR7am9pbk5hbWV9LiR7ZXh0cmF9YCk7XG4gICAgICAgIH0pO1xuICAgICAgfVxuICAgICAgc2VsZWN0cy5wdXNoKGtuZXgucmF3KFxuICAgICAgICBgQ09BTEVTQ0UoXG4gICAgICAgICAgYXJyYXlfYWdnKFxuICAgICAgICAgICAgZGlzdGluY3QoXG4gICAgICAgICAgICAgIGpzb25iX2J1aWxkX29iamVjdChcbiAgICAgICAgICAgICAgICAnaWQnLCAke2pvaW5OYW1lfS4ke3JlbC4kc2lkZXNba2V5XS5vdGhlci5maWVsZH1cbiAgICAgICAgICAgICAgICAke2V4dHJhQWdnLmxlbmd0aCA/ICcsJyArIGV4dHJhQWdnLmpvaW4oJywnKSA6ICcnfVxuICAgICAgICAgICAgICApXG4gICAgICAgICAgICApXG4gICAgICAgICAgKVxuICAgICAgICAgIEZJTFRFUiAoV0hFUkUgJHtqb2luTmFtZX0uJHtyZWwuJHNpZGVzW2tleV0ub3RoZXIuZmllbGR9IElTIE5PVCBOVUxMKSxcbiAgICAgICAgICAne30nKVxuICAgICAgICBhcyAke2tleX1gXG4gICAgICApKTtcbiAgICB9IGVsc2Uge1xuICAgICAgc2VsZWN0cy5wdXNoKGtleSk7XG4gICAgICBncm91cHMucHVzaChrZXkpO1xuICAgIH1cbiAgfSk7XG4gIGNvbnN0IGpvaW5lZFF1ZXJ5ID0gYmFzaWNKb2lucy5yZWR1Y2UoKHEsIGpvaW4pID0+IHtcbiAgICByZXR1cm4gcS5sZWZ0T3V0ZXJKb2luKGpvaW4uam9pblswXSwgKHFiKSA9PiB7XG4gICAgICBxYi5vbihqb2luLmpvaW5bMV0sIGpvaW4uam9pblsyXSwgam9pbi5qb2luWzNdKTtcbiAgICAgIGpvaW4ud2hlcmUuZm9yRWFjaCgod2hlcmUpID0+IHFiLmFuZE9uLmFwcGx5KHFiLCB3aGVyZSkpO1xuICAgIH0pO1xuICB9LCBrbmV4KFR5cGUuJG5hbWUpKTtcblxuICBjb25zdCBldmVuTW9yZUpvaW5lZFF1ZXJ5ID0gZmFuY3lKb2lucy5yZWR1Y2UoKHEsIGpvaW4pID0+IHtcbiAgICByZXR1cm4gcS5sZWZ0T3V0ZXJKb2luKGpvaW4udGFibGUsIChxYikgPT4ge1xuICAgICAgcmV0dXJuIGRlc2VyaWFsaXplV2hlcmVJbnRvSm9pbihxYiwgam9pbi5sb2dpYywgam9pbi5qb2luTmFtZSwgam9pbi5maWVsZE5hbWUsIGtuZXgsIFR5cGUpO1xuICAgIH0pO1xuICB9LCBqb2luZWRRdWVyeSk7XG4gIGNvbnN0IHNlbGVjdGVkUXVlcnkgPSBldmVuTW9yZUpvaW5lZFF1ZXJ5LndoZXJlKHF1ZXJ5KS5zZWxlY3Qoc2VsZWN0cyk7XG4gIGNvbnN0IGdyb3VwQnlRdWVyeSA9IHNlbGVjdGVkUXVlcnkuZ3JvdXBCeShncm91cHMpO1xuICAvLyBjb25zb2xlLmxvZyhncm91cEJ5UXVlcnkudG9TdHJpbmcoKSk7XG4gIHJldHVybiBncm91cEJ5UXVlcnk7XG59XG4iXX0=
