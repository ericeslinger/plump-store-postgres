"use strict";
var __extends = (this && this.__extends) || (function () {
    var extendStatics = Object.setPrototypeOf ||
        ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
        function (d, b) { for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p]; };
    return function (d, b) {
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();
Object.defineProperty(exports, "__esModule", { value: true });
var knex = require("knex");
var plump_1 = require("plump");
var queryString_1 = require("./queryString");
var writeRelationshipQuery_1 = require("./writeRelationshipQuery");
function rearrangeData(type, data) {
    var retVal = {
        type: type.name,
        attributes: {},
        relationships: {},
        id: data[type.idAttribute],
    };
    for (var attrName in type.attributes) {
        retVal.attributes[attrName] = data[attrName];
    }
    for (var relName in type.relationships) {
        retVal.relationships[relName] = data[relName] || [];
    }
    return retVal;
}
var PGStore = (function (_super) {
    __extends(PGStore, _super);
    function PGStore(opts) {
        if (opts === void 0) { opts = {}; }
        var _this = _super.call(this, opts) || this;
        _this.queryCache = {};
        var options = Object.assign({}, {
            client: 'postgres',
            debug: false,
            connection: {
                user: 'postgres',
                host: 'localhost',
                port: 5432,
                password: '',
                charset: 'utf8',
            },
            pool: {
                max: 20,
                min: 0,
            },
        }, opts.sql);
        _this.knex = knex(options);
        return _this;
    }
    PGStore.prototype.teardown = function () {
        return Promise.resolve(this.knex.destroy());
    };
    PGStore.prototype.allocateId = function (type) {
        return Promise.resolve(this.knex
            .raw('select nextval(?::regclass);', type + "_id_seq")
            .then(function (data) { return data.rows[0].nextval; }));
    };
    PGStore.prototype.addSchema = function (t) {
        var _this = this;
        return _super.prototype.addSchema.call(this, t).then(function () {
            _this.queryCache[t.type] = {
                attributes: queryString_1.readQuery(t.schema),
                bulkRead: queryString_1.bulkQuery(t.schema),
                relationships: {},
            };
            Object.keys(t.schema.relationships).forEach(function (relName) {
                _this.queryCache[t.type].relationships[relName] = writeRelationshipQuery_1.writeRelationshipQuery(t.schema, relName);
            });
        });
    };
    PGStore.prototype.writeAttributes = function (value) {
        var _this = this;
        var updateObject = this.validateInput(value);
        var typeInfo = this.getSchema(value.type);
        return Promise.resolve()
            .then(function () {
            if (updateObject.id === undefined && _this.terminal) {
                return _this.knex(typeInfo.storeData.sql.tableName)
                    .insert(updateObject.attributes)
                    .returning(typeInfo.idAttribute)
                    .then(function (createdId) {
                    return _this.readAttributes({ type: value.type, id: createdId });
                });
            }
            else if (updateObject.id !== undefined) {
                return _this.knex(updateObject.type)
                    .where((_a = {}, _a[typeInfo.idAttribute] = updateObject.id, _a))
                    .update(updateObject.attributes)
                    .then(function () {
                    return _this.readAttributes({
                        type: value.type,
                        id: updateObject.id,
                    });
                });
            }
            else {
                throw new Error('Cannot create new content in a non-terminal store');
            }
            var _a;
        })
            .then(function (result) {
            _this.fireWriteUpdate(Object.assign({}, result, { invalidate: ['attributes'] }));
            return result;
        });
    };
    PGStore.prototype.readAttributes = function (value) {
        var _this = this;
        return Promise.resolve(this.knex
            .raw(this.queryCache[value.type].attributes.queryString, value.id)
            .then(function (o) {
            if (o.rows[0]) {
                return rearrangeData(_this.getSchema(value.type), o.rows[0]);
            }
            else {
                return null;
            }
        }));
    };
    PGStore.prototype.bulkRead = function (item) {
        var schema = this.getSchema(item.type);
        var query = this.queryCache[item.type].bulkRead;
        return Promise.resolve(this.knex.raw(query.queryString, item.id).then(function (o) {
            if (o.rows[0]) {
                var arrangedArray = o.rows.map(function (row) { return rearrangeData(schema, row); });
                var rootItem = arrangedArray.filter(function (it) { return it.id === item.id; })[0];
                rootItem.included = arrangedArray.filter(function (it) { return it.id !== item.id; });
                return rootItem;
            }
            else {
                return null;
            }
        }));
    };
    PGStore.prototype.readRelationship = function (value, relRefName) {
        var relName = relRefName.indexOf('relationships.') === 0
            ? relRefName.split('.')[1]
            : relRefName;
        var schema = this.getSchema(value.type);
        var rel = schema.relationships[relName].type;
        var otherRelName = rel.sides[relName].otherName;
        var sqlData = rel.storeData.sql;
        var selectBase = "\"" + sqlData.tableName + "\".\"" + sqlData.joinFields[otherRelName] + "\" as id";
        var selectExtras = '';
        if (rel.extras) {
            selectExtras = ", jsonb_build_object(" + Object.keys(rel.extras)
                .map(function (extra) { return "'" + extra + "', \"" + sqlData.tableName + "\".\"" + extra + "\""; })
                .join(', ') + ") as meta";
        }
        var where = sqlData.where === undefined
            ? (_a = {}, _a[sqlData.joinFields[relName]] = value.id, _a) : this.knex.raw(sqlData.where[relName], value.id);
        return Promise.resolve(this.knex(sqlData.tableName)
            .as(relName)
            .where(where)
            .select(this.knex.raw("" + selectBase + selectExtras))
            .then(function (l) {
            return {
                type: value.type,
                id: value.id,
                relationships: (_a = {},
                    _a[relName] = l,
                    _a),
            };
            var _a;
        }));
        var _a;
    };
    PGStore.prototype.delete = function (value) {
        var _this = this;
        var schema = this.getSchema(value.type);
        return Promise.resolve(this.knex(schema.storeData.sql.tableName)
            .where((_a = {}, _a[schema.idAttribute] = value.id, _a))
            .delete()
            .then(function (o) {
            _this.fireWriteUpdate({
                id: value.id,
                type: value.type,
                invalidate: ['attributes', 'relationships'],
            });
            return o;
        }));
        var _a;
    };
    PGStore.prototype.writeRelationshipItem = function (value, relName, child) {
        var _this = this;
        var subQuery = this.queryCache[value.type].relationships[relName];
        var schema = this.getSchema(value.type);
        var childData = schema.relationships[relName].type.sides[relName];
        return Promise.resolve(this.knex
            .raw(subQuery.queryString, subQuery.fields.map(function (f) {
            if (f === 'item.id') {
                return value.id;
            }
            else if (f === 'child.id') {
                return child.id;
            }
            else {
                return child.meta[f];
            }
        }))
            .then(function () {
            _this.fireWriteUpdate(Object.assign({}, value, {
                invalidate: ["relationships." + relName],
            }));
            _this.fireWriteUpdate({
                id: child.id,
                type: childData.otherType,
                invalidate: ["relationships." + childData.otherName],
            });
            return null;
        }));
    };
    PGStore.prototype.deleteRelationshipItem = function (value, relName, child) {
        var _this = this;
        var schema = this.getSchema(value.type);
        var rel = schema.relationships[relName].type;
        var otherRelName = rel.sides[relName].otherName;
        var sqlData = rel.storeData.sql;
        var childData = schema.relationships[relName].type.sides[relName];
        return Promise.resolve(this.knex(sqlData.tableName)
            .where((_a = {},
            _a[sqlData.joinFields[otherRelName]] = child.id,
            _a[sqlData.joinFields[relName]] = value.id,
            _a))
            .delete()
            .then(function () {
            _this.fireWriteUpdate(Object.assign({}, value, {
                invalidate: ["relationships." + relName],
            }));
            _this.fireWriteUpdate({
                id: child.id,
                type: childData.otherType,
                invalidate: ["relationships." + childData.otherName],
            });
            return null;
        }));
        var _a;
    };
    PGStore.prototype.query = function (type, q) {
        return Promise.resolve(this.knex(type)
            .where(q)
            .select('id')
            .then(function (r) { return r.map(function (v) { return ({ type: type, id: v.id }); }); }));
    };
    return PGStore;
}(plump_1.Storage));
exports.PGStore = PGStore;

//# sourceMappingURL=data:application/json;charset=utf8;base64,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SUFDSCxjQUFDO0FBQUQsQ0FuUkEsQUFtUkMsQ0FuUjRCLGVBQU8sR0FtUm5DO0FBblJZLDBCQUFPIiwiZmlsZSI6InNxbC5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIGtuZXggZnJvbSAna25leCc7XG5pbXBvcnQge1xuICBTdG9yYWdlLFxuICBJbmRlZmluaXRlTW9kZWxEYXRhLFxuICBNb2RlbERhdGEsXG4gIE1vZGVsU2NoZW1hLFxuICBNb2RlbFJlZmVyZW5jZSxcbiAgUmVsYXRpb25zaGlwSXRlbSxcbiAgVGVybWluYWxTdG9yZSxcbn0gZnJvbSAncGx1bXAnO1xuaW1wb3J0IHsgcmVhZFF1ZXJ5LCBidWxrUXVlcnkgfSBmcm9tICcuL3F1ZXJ5U3RyaW5nJztcbmltcG9ydCB7IFBhcmFtZXRlcml6ZWRRdWVyeSB9IGZyb20gJy4vc2VtaVF1ZXJ5JztcbmltcG9ydCB7IHdyaXRlUmVsYXRpb25zaGlwUXVlcnkgfSBmcm9tICcuL3dyaXRlUmVsYXRpb25zaGlwUXVlcnknO1xuXG5mdW5jdGlvbiByZWFycmFuZ2VEYXRhKHR5cGU6IE1vZGVsU2NoZW1hLCBkYXRhOiBhbnkpOiBNb2RlbERhdGEge1xuICBjb25zdCByZXRWYWw6IE1vZGVsRGF0YSA9IHtcbiAgICB0eXBlOiB0eXBlLm5hbWUsXG4gICAgYXR0cmlidXRlczoge30sXG4gICAgcmVsYXRpb25zaGlwczoge30sXG4gICAgaWQ6IGRhdGFbdHlwZS5pZEF0dHJpYnV0ZV0sXG4gIH07XG4gIGZvciAoY29uc3QgYXR0ck5hbWUgaW4gdHlwZS5hdHRyaWJ1dGVzKSB7XG4gICAgcmV0VmFsLmF0dHJpYnV0ZXNbYXR0ck5hbWVdID0gZGF0YVthdHRyTmFtZV07XG4gIH1cbiAgZm9yIChjb25zdCByZWxOYW1lIGluIHR5cGUucmVsYXRpb25zaGlwcykge1xuICAgIHJldFZhbC5yZWxhdGlvbnNoaXBzW3JlbE5hbWVdID0gZGF0YVtyZWxOYW1lXSB8fCBbXTtcbiAgfVxuICByZXR1cm4gcmV0VmFsO1xufVxuXG5leHBvcnQgY2xhc3MgUEdTdG9yZSBleHRlbmRzIFN0b3JhZ2UgaW1wbGVtZW50cyBUZXJtaW5hbFN0b3JlIHtcbiAgcHVibGljIGtuZXg6IGtuZXg7XG4gIHByaXZhdGUgcXVlcnlDYWNoZToge1xuICAgIFt0eXBlOiBzdHJpbmddOiB7XG4gICAgICBhdHRyaWJ1dGVzOiBQYXJhbWV0ZXJpemVkUXVlcnk7XG4gICAgICBidWxrUmVhZDogUGFyYW1ldGVyaXplZFF1ZXJ5O1xuICAgICAgcmVsYXRpb25zaGlwczoge1xuICAgICAgICBbcmVsTmFtZTogc3RyaW5nXTogUGFyYW1ldGVyaXplZFF1ZXJ5O1xuICAgICAgfTtcbiAgICB9O1xuICB9ID0ge307XG5cbiAgY29uc3RydWN0b3Iob3B0czogeyBbb3B0OiBzdHJpbmddOiBhbnkgfSA9IHt9KSB7XG4gICAgc3VwZXIob3B0cyk7XG4gICAgY29uc3Qgb3B0aW9ucyA9IE9iamVjdC5hc3NpZ24oXG4gICAgICB7fSxcbiAgICAgIHtcbiAgICAgICAgY2xpZW50OiAncG9zdGdyZXMnLFxuICAgICAgICBkZWJ1ZzogZmFsc2UsXG4gICAgICAgIGNvbm5lY3Rpb246IHtcbiAgICAgICAgICB1c2VyOiAncG9zdGdyZXMnLFxuICAgICAgICAgIGhvc3Q6ICdsb2NhbGhvc3QnLFxuICAgICAgICAgIHBvcnQ6IDU0MzIsXG4gICAgICAgICAgcGFzc3dvcmQ6ICcnLFxuICAgICAgICAgIGNoYXJzZXQ6ICd1dGY4JyxcbiAgICAgICAgfSxcbiAgICAgICAgcG9vbDoge1xuICAgICAgICAgIG1heDogMjAsXG4gICAgICAgICAgbWluOiAwLFxuICAgICAgICB9LFxuICAgICAgfSxcbiAgICAgIG9wdHMuc3FsLFxuICAgICk7XG4gICAgdGhpcy5rbmV4ID0ga25leChvcHRpb25zKTtcbiAgfVxuXG4gIC8qXG4gICAgbm90ZSB0aGF0IGtuZXguanMgXCJ0aGVuXCIgZnVuY3Rpb25zIGFyZW4ndCBhY3R1YWxseSBwcm9taXNlcyB0aGUgd2F5IHlvdSB0aGluayB0aGV5IGFyZS5cbiAgICB5b3UgY2FuIHJldHVybiBrbmV4Lmluc2VydCgpLmludG8oKSwgd2hpY2ggaGFzIGEgdGhlbigpIG9uIGl0LCBidXQgdGhhdCB0aGVuYWJsZSBpc24ndFxuICAgIGFuIGFjdHVhbCBwcm9taXNlIHlldC4gU28gaW5zdGVhZCB3ZSdyZSByZXR1cm5pbmcgUHJvbWlzZS5yZXNvbHZlKHRoZW5hYmxlKTtcbiAgKi9cblxuICB0ZWFyZG93bigpIHtcbiAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKHRoaXMua25leC5kZXN0cm95KCkpO1xuICB9XG5cbiAgYWxsb2NhdGVJZCh0eXBlOiBzdHJpbmcpOiBQcm9taXNlPG51bWJlcj4ge1xuICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoXG4gICAgICB0aGlzLmtuZXhcbiAgICAgICAgLnJhdygnc2VsZWN0IG5leHR2YWwoPzo6cmVnY2xhc3MpOycsIGAke3R5cGV9X2lkX3NlcWApXG4gICAgICAgIC50aGVuKGRhdGEgPT4gZGF0YS5yb3dzWzBdLm5leHR2YWwpLFxuICAgICk7XG4gIH1cblxuICBhZGRTY2hlbWEodDogeyB0eXBlOiBzdHJpbmc7IHNjaGVtYTogTW9kZWxTY2hlbWEgfSkge1xuICAgIHJldHVybiBzdXBlci5hZGRTY2hlbWEodCkudGhlbigoKSA9PiB7XG4gICAgICB0aGlzLnF1ZXJ5Q2FjaGVbdC50eXBlXSA9IHtcbiAgICAgICAgYXR0cmlidXRlczogcmVhZFF1ZXJ5KHQuc2NoZW1hKSxcbiAgICAgICAgYnVsa1JlYWQ6IGJ1bGtRdWVyeSh0LnNjaGVtYSksXG4gICAgICAgIHJlbGF0aW9uc2hpcHM6IHt9LFxuICAgICAgfTtcbiAgICAgIE9iamVjdC5rZXlzKHQuc2NoZW1hLnJlbGF0aW9uc2hpcHMpLmZvckVhY2gocmVsTmFtZSA9PiB7XG4gICAgICAgIHRoaXMucXVlcnlDYWNoZVt0LnR5cGVdLnJlbGF0aW9uc2hpcHNbcmVsTmFtZV0gPSB3cml0ZVJlbGF0aW9uc2hpcFF1ZXJ5KFxuICAgICAgICAgIHQuc2NoZW1hLFxuICAgICAgICAgIHJlbE5hbWUsXG4gICAgICAgICk7XG4gICAgICB9KTtcbiAgICB9KTtcbiAgfVxuXG4gIHdyaXRlQXR0cmlidXRlcyh2YWx1ZTogSW5kZWZpbml0ZU1vZGVsRGF0YSk6IFByb21pc2U8TW9kZWxEYXRhPiB7XG4gICAgY29uc3QgdXBkYXRlT2JqZWN0ID0gdGhpcy52YWxpZGF0ZUlucHV0KHZhbHVlKTtcbiAgICBjb25zdCB0eXBlSW5mbyA9IHRoaXMuZ2V0U2NoZW1hKHZhbHVlLnR5cGUpO1xuICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoKVxuICAgICAgLnRoZW4oKCkgPT4ge1xuICAgICAgICBpZiAodXBkYXRlT2JqZWN0LmlkID09PSB1bmRlZmluZWQgJiYgdGhpcy50ZXJtaW5hbCkge1xuICAgICAgICAgIHJldHVybiB0aGlzLmtuZXgodHlwZUluZm8uc3RvcmVEYXRhLnNxbC50YWJsZU5hbWUpXG4gICAgICAgICAgICAuaW5zZXJ0KHVwZGF0ZU9iamVjdC5hdHRyaWJ1dGVzKVxuICAgICAgICAgICAgLnJldHVybmluZyh0eXBlSW5mby5pZEF0dHJpYnV0ZSlcbiAgICAgICAgICAgIC50aGVuKGNyZWF0ZWRJZCA9PiB7XG4gICAgICAgICAgICAgIHJldHVybiB0aGlzLnJlYWRBdHRyaWJ1dGVzKHsgdHlwZTogdmFsdWUudHlwZSwgaWQ6IGNyZWF0ZWRJZCB9KTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9IGVsc2UgaWYgKHVwZGF0ZU9iamVjdC5pZCAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgcmV0dXJuIHRoaXMua25leCh1cGRhdGVPYmplY3QudHlwZSlcbiAgICAgICAgICAgIC53aGVyZSh7IFt0eXBlSW5mby5pZEF0dHJpYnV0ZV06IHVwZGF0ZU9iamVjdC5pZCB9KVxuICAgICAgICAgICAgLnVwZGF0ZSh1cGRhdGVPYmplY3QuYXR0cmlidXRlcylcbiAgICAgICAgICAgIC50aGVuKCgpID0+IHtcbiAgICAgICAgICAgICAgcmV0dXJuIHRoaXMucmVhZEF0dHJpYnV0ZXMoe1xuICAgICAgICAgICAgICAgIHR5cGU6IHZhbHVlLnR5cGUsXG4gICAgICAgICAgICAgICAgaWQ6IHVwZGF0ZU9iamVjdC5pZCxcbiAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0Nhbm5vdCBjcmVhdGUgbmV3IGNvbnRlbnQgaW4gYSBub24tdGVybWluYWwgc3RvcmUnKTtcbiAgICAgICAgfVxuICAgICAgfSlcbiAgICAgIC50aGVuKHJlc3VsdCA9PiB7XG4gICAgICAgIHRoaXMuZmlyZVdyaXRlVXBkYXRlKFxuICAgICAgICAgIE9iamVjdC5hc3NpZ24oe30sIHJlc3VsdCwgeyBpbnZhbGlkYXRlOiBbJ2F0dHJpYnV0ZXMnXSB9KSxcbiAgICAgICAgKTtcbiAgICAgICAgcmV0dXJuIHJlc3VsdDtcbiAgICAgIH0pO1xuICB9XG5cbiAgcmVhZEF0dHJpYnV0ZXModmFsdWU6IE1vZGVsUmVmZXJlbmNlKTogUHJvbWlzZTxNb2RlbERhdGE+IHtcbiAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKFxuICAgICAgdGhpcy5rbmV4XG4gICAgICAgIC5yYXcodGhpcy5xdWVyeUNhY2hlW3ZhbHVlLnR5cGVdLmF0dHJpYnV0ZXMucXVlcnlTdHJpbmcsIHZhbHVlLmlkKVxuICAgICAgICAudGhlbihvID0+IHtcbiAgICAgICAgICBpZiAoby5yb3dzWzBdKSB7XG4gICAgICAgICAgICByZXR1cm4gcmVhcnJhbmdlRGF0YSh0aGlzLmdldFNjaGVtYSh2YWx1ZS50eXBlKSwgby5yb3dzWzBdKTtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgICAgICAgfVxuICAgICAgICB9KSxcbiAgICApO1xuICB9XG5cbiAgYnVsa1JlYWQoaXRlbTogTW9kZWxSZWZlcmVuY2UpIHtcbiAgICBjb25zdCBzY2hlbWEgPSB0aGlzLmdldFNjaGVtYShpdGVtLnR5cGUpO1xuICAgIGNvbnN0IHF1ZXJ5ID0gdGhpcy5xdWVyeUNhY2hlW2l0ZW0udHlwZV0uYnVsa1JlYWQ7XG4gICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZShcbiAgICAgIHRoaXMua25leC5yYXcocXVlcnkucXVlcnlTdHJpbmcsIGl0ZW0uaWQpLnRoZW4obyA9PiB7XG4gICAgICAgIGlmIChvLnJvd3NbMF0pIHtcbiAgICAgICAgICBjb25zdCBhcnJhbmdlZEFycmF5ID0gby5yb3dzLm1hcChyb3cgPT4gcmVhcnJhbmdlRGF0YShzY2hlbWEsIHJvdykpO1xuICAgICAgICAgIGNvbnN0IHJvb3RJdGVtID0gYXJyYW5nZWRBcnJheS5maWx0ZXIoaXQgPT4gaXQuaWQgPT09IGl0ZW0uaWQpWzBdO1xuICAgICAgICAgIHJvb3RJdGVtLmluY2x1ZGVkID0gYXJyYW5nZWRBcnJheS5maWx0ZXIoaXQgPT4gaXQuaWQgIT09IGl0ZW0uaWQpO1xuICAgICAgICAgIHJldHVybiByb290SXRlbTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICByZXR1cm4gbnVsbDtcbiAgICAgICAgfVxuICAgICAgfSksXG4gICAgKTtcbiAgfVxuXG4gIHJlYWRSZWxhdGlvbnNoaXAoXG4gICAgdmFsdWU6IE1vZGVsUmVmZXJlbmNlLFxuICAgIHJlbFJlZk5hbWU6IHN0cmluZyxcbiAgKTogUHJvbWlzZTxNb2RlbERhdGE+IHtcbiAgICBjb25zdCByZWxOYW1lID1cbiAgICAgIHJlbFJlZk5hbWUuaW5kZXhPZigncmVsYXRpb25zaGlwcy4nKSA9PT0gMFxuICAgICAgICA/IHJlbFJlZk5hbWUuc3BsaXQoJy4nKVsxXVxuICAgICAgICA6IHJlbFJlZk5hbWU7XG4gICAgY29uc3Qgc2NoZW1hID0gdGhpcy5nZXRTY2hlbWEodmFsdWUudHlwZSk7XG4gICAgY29uc3QgcmVsID0gc2NoZW1hLnJlbGF0aW9uc2hpcHNbcmVsTmFtZV0udHlwZTtcbiAgICBjb25zdCBvdGhlclJlbE5hbWUgPSByZWwuc2lkZXNbcmVsTmFtZV0ub3RoZXJOYW1lO1xuICAgIGNvbnN0IHNxbERhdGEgPSByZWwuc3RvcmVEYXRhLnNxbDtcbiAgICBjb25zdCBzZWxlY3RCYXNlID0gYFwiJHtzcWxEYXRhLnRhYmxlTmFtZX1cIi5cIiR7c3FsRGF0YS5qb2luRmllbGRzW1xuICAgICAgb3RoZXJSZWxOYW1lXG4gICAgXX1cIiBhcyBpZGA7XG4gICAgbGV0IHNlbGVjdEV4dHJhcyA9ICcnO1xuICAgIGlmIChyZWwuZXh0cmFzKSB7XG4gICAgICBzZWxlY3RFeHRyYXMgPSBgLCBqc29uYl9idWlsZF9vYmplY3QoJHtPYmplY3Qua2V5cyhyZWwuZXh0cmFzKVxuICAgICAgICAubWFwKGV4dHJhID0+IGAnJHtleHRyYX0nLCBcIiR7c3FsRGF0YS50YWJsZU5hbWV9XCIuXCIke2V4dHJhfVwiYClcbiAgICAgICAgLmpvaW4oJywgJyl9KSBhcyBtZXRhYDsgLy8gdHNsaW50OmRpc2FibGUtbGluZSBtYXgtbGluZS1sZW5ndGhcbiAgICB9XG5cbiAgICBjb25zdCB3aGVyZSA9XG4gICAgICBzcWxEYXRhLndoZXJlID09PSB1bmRlZmluZWRcbiAgICAgICAgPyB7IFtzcWxEYXRhLmpvaW5GaWVsZHNbcmVsTmFtZV1dOiB2YWx1ZS5pZCB9XG4gICAgICAgIDogdGhpcy5rbmV4LnJhdyhzcWxEYXRhLndoZXJlW3JlbE5hbWVdLCB2YWx1ZS5pZCk7XG5cbiAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKFxuICAgICAgdGhpcy5rbmV4KHNxbERhdGEudGFibGVOYW1lKVxuICAgICAgICAuYXMocmVsTmFtZSlcbiAgICAgICAgLndoZXJlKHdoZXJlKVxuICAgICAgICAuc2VsZWN0KHRoaXMua25leC5yYXcoYCR7c2VsZWN0QmFzZX0ke3NlbGVjdEV4dHJhc31gKSlcbiAgICAgICAgLnRoZW4obCA9PiB7XG4gICAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgIHR5cGU6IHZhbHVlLnR5cGUsXG4gICAgICAgICAgICBpZDogdmFsdWUuaWQsXG4gICAgICAgICAgICByZWxhdGlvbnNoaXBzOiB7XG4gICAgICAgICAgICAgIFtyZWxOYW1lXTogbCxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgfTtcbiAgICAgICAgfSksXG4gICAgKTtcbiAgfVxuXG4gIGRlbGV0ZSh2YWx1ZTogTW9kZWxSZWZlcmVuY2UpIHtcbiAgICBjb25zdCBzY2hlbWEgPSB0aGlzLmdldFNjaGVtYSh2YWx1ZS50eXBlKTtcbiAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKFxuICAgICAgdGhpcy5rbmV4KHNjaGVtYS5zdG9yZURhdGEuc3FsLnRhYmxlTmFtZSlcbiAgICAgICAgLndoZXJlKHsgW3NjaGVtYS5pZEF0dHJpYnV0ZV06IHZhbHVlLmlkIH0pXG4gICAgICAgIC5kZWxldGUoKVxuICAgICAgICAudGhlbihvID0+IHtcbiAgICAgICAgICB0aGlzLmZpcmVXcml0ZVVwZGF0ZSh7XG4gICAgICAgICAgICBpZDogdmFsdWUuaWQsXG4gICAgICAgICAgICB0eXBlOiB2YWx1ZS50eXBlLFxuICAgICAgICAgICAgaW52YWxpZGF0ZTogWydhdHRyaWJ1dGVzJywgJ3JlbGF0aW9uc2hpcHMnXSxcbiAgICAgICAgICB9KTtcbiAgICAgICAgICByZXR1cm4gbztcbiAgICAgICAgfSksXG4gICAgKTtcbiAgfVxuXG4gIHdyaXRlUmVsYXRpb25zaGlwSXRlbShcbiAgICB2YWx1ZTogTW9kZWxSZWZlcmVuY2UsXG4gICAgcmVsTmFtZTogc3RyaW5nLFxuICAgIGNoaWxkOiBSZWxhdGlvbnNoaXBJdGVtLFxuICApIHtcbiAgICBjb25zdCBzdWJRdWVyeSA9IHRoaXMucXVlcnlDYWNoZVt2YWx1ZS50eXBlXS5yZWxhdGlvbnNoaXBzW3JlbE5hbWVdO1xuICAgIGNvbnN0IHNjaGVtYSA9IHRoaXMuZ2V0U2NoZW1hKHZhbHVlLnR5cGUpO1xuICAgIGNvbnN0IGNoaWxkRGF0YSA9IHNjaGVtYS5yZWxhdGlvbnNoaXBzW3JlbE5hbWVdLnR5cGUuc2lkZXNbcmVsTmFtZV07XG4gICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZShcbiAgICAgIHRoaXMua25leFxuICAgICAgICAucmF3KFxuICAgICAgICAgIHN1YlF1ZXJ5LnF1ZXJ5U3RyaW5nLFxuICAgICAgICAgIHN1YlF1ZXJ5LmZpZWxkcy5tYXAoZiA9PiB7XG4gICAgICAgICAgICBpZiAoZiA9PT0gJ2l0ZW0uaWQnKSB7XG4gICAgICAgICAgICAgIHJldHVybiB2YWx1ZS5pZDtcbiAgICAgICAgICAgIH0gZWxzZSBpZiAoZiA9PT0gJ2NoaWxkLmlkJykge1xuICAgICAgICAgICAgICByZXR1cm4gY2hpbGQuaWQ7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICByZXR1cm4gY2hpbGQubWV0YVtmXTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9KSxcbiAgICAgICAgKVxuICAgICAgICAudGhlbigoKSA9PiB7XG4gICAgICAgICAgdGhpcy5maXJlV3JpdGVVcGRhdGUoXG4gICAgICAgICAgICBPYmplY3QuYXNzaWduKHt9LCB2YWx1ZSwge1xuICAgICAgICAgICAgICBpbnZhbGlkYXRlOiBbYHJlbGF0aW9uc2hpcHMuJHtyZWxOYW1lfWBdLFxuICAgICAgICAgICAgfSksXG4gICAgICAgICAgKTtcbiAgICAgICAgICB0aGlzLmZpcmVXcml0ZVVwZGF0ZSh7XG4gICAgICAgICAgICBpZDogY2hpbGQuaWQsXG4gICAgICAgICAgICB0eXBlOiBjaGlsZERhdGEub3RoZXJUeXBlLFxuICAgICAgICAgICAgaW52YWxpZGF0ZTogW2ByZWxhdGlvbnNoaXBzLiR7Y2hpbGREYXRhLm90aGVyTmFtZX1gXSxcbiAgICAgICAgICB9KTtcbiAgICAgICAgICByZXR1cm4gbnVsbDtcbiAgICAgICAgfSksXG4gICAgKTtcbiAgfVxuXG4gIGRlbGV0ZVJlbGF0aW9uc2hpcEl0ZW0oXG4gICAgdmFsdWU6IE1vZGVsUmVmZXJlbmNlLFxuICAgIHJlbE5hbWU6IHN0cmluZyxcbiAgICBjaGlsZDogUmVsYXRpb25zaGlwSXRlbSxcbiAgKSB7XG4gICAgY29uc3Qgc2NoZW1hID0gdGhpcy5nZXRTY2hlbWEodmFsdWUudHlwZSk7XG4gICAgY29uc3QgcmVsID0gc2NoZW1hLnJlbGF0aW9uc2hpcHNbcmVsTmFtZV0udHlwZTtcbiAgICBjb25zdCBvdGhlclJlbE5hbWUgPSByZWwuc2lkZXNbcmVsTmFtZV0ub3RoZXJOYW1lO1xuICAgIGNvbnN0IHNxbERhdGEgPSByZWwuc3RvcmVEYXRhLnNxbDtcbiAgICBjb25zdCBjaGlsZERhdGEgPSBzY2hlbWEucmVsYXRpb25zaGlwc1tyZWxOYW1lXS50eXBlLnNpZGVzW3JlbE5hbWVdO1xuICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoXG4gICAgICB0aGlzLmtuZXgoc3FsRGF0YS50YWJsZU5hbWUpXG4gICAgICAgIC53aGVyZSh7XG4gICAgICAgICAgW3NxbERhdGEuam9pbkZpZWxkc1tvdGhlclJlbE5hbWVdXTogY2hpbGQuaWQsXG4gICAgICAgICAgW3NxbERhdGEuam9pbkZpZWxkc1tyZWxOYW1lXV06IHZhbHVlLmlkLFxuICAgICAgICB9KVxuICAgICAgICAuZGVsZXRlKClcbiAgICAgICAgLnRoZW4oKCkgPT4ge1xuICAgICAgICAgIHRoaXMuZmlyZVdyaXRlVXBkYXRlKFxuICAgICAgICAgICAgT2JqZWN0LmFzc2lnbih7fSwgdmFsdWUsIHtcbiAgICAgICAgICAgICAgaW52YWxpZGF0ZTogW2ByZWxhdGlvbnNoaXBzLiR7cmVsTmFtZX1gXSxcbiAgICAgICAgICAgIH0pLFxuICAgICAgICAgICk7XG4gICAgICAgICAgdGhpcy5maXJlV3JpdGVVcGRhdGUoe1xuICAgICAgICAgICAgaWQ6IGNoaWxkLmlkLFxuICAgICAgICAgICAgdHlwZTogY2hpbGREYXRhLm90aGVyVHlwZSxcbiAgICAgICAgICAgIGludmFsaWRhdGU6IFtgcmVsYXRpb25zaGlwcy4ke2NoaWxkRGF0YS5vdGhlck5hbWV9YF0sXG4gICAgICAgICAgfSk7XG4gICAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgICAgIH0pLFxuICAgICk7XG4gIH1cblxuICBxdWVyeSh0eXBlOiBzdHJpbmcsIHE6IGFueSkge1xuICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoXG4gICAgICB0aGlzLmtuZXgodHlwZSlcbiAgICAgICAgLndoZXJlKHEpXG4gICAgICAgIC5zZWxlY3QoJ2lkJylcbiAgICAgICAgLnRoZW4ociA9PiByLm1hcCh2ID0+ICh7IHR5cGU6IHR5cGUsIGlkOiB2LmlkIH0pKSksXG4gICAgKTtcbiAgfVxufVxuIl19
