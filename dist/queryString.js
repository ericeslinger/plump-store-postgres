"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
function selects(schema) {
    var selectArray = [];
    for (var attrName in schema.attributes) {
        selectArray.push("\"" + schema.storeData.sql.tableName + "\".\"" + attrName + "\"");
    }
    for (var relName in schema.relationships) {
        var rel = schema.relationships[relName].type;
        var otherName = rel.sides[relName].otherName;
        var otherFieldName = rel.storeData.sql.joinFields[otherName];
        var extraAgg = [];
        if (rel.extras) {
            for (var extra in rel.extras) {
                extraAgg.push("'" + extra + "'", "\"" + relName + "\".\"" + extra + "\"");
            }
        }
        var extraString = ", 'meta', jsonb_build_object(" + extraAgg.join(', ') + ")";
        selectArray.push("COALESCE(\n        array_agg(\n          distinct(\n            jsonb_build_object(\n              'id', \"" + relName + "\".\"" + otherFieldName + "\"\n              " + (extraAgg.length ? extraString : '') + "\n            )\n          )\n        )\n        FILTER (WHERE \"" + relName + "\".\"" + otherFieldName + "\" IS NOT NULL),\n        '{}')\n      as \"" + relName + "\"");
    }
    return "select " + selectArray.join(', ');
}
function joins(schema) {
    var joinStrings = [];
    for (var relName in schema.relationships) {
        var rel = schema.relationships[relName].type;
        var sqlBlock = rel.storeData.sql;
        if (sqlBlock.joinQuery) {
            joinStrings.push("left outer join " + rel.storeData.sql.tableName + " as \"" + relName + "\" " + sqlBlock.joinQuery[relName]);
        }
        else {
            joinStrings.push("left outer join " + rel.storeData.sql.tableName + " as \"" + relName + "\" "
                + ("on \"" + relName + "\"." + sqlBlock.joinFields[relName] + " = " + schema.storeData.sql.tableName + "." + schema.idAttribute));
        }
    }
    return joinStrings.join('\n');
}
function singleWhere(schema) {
    if (schema.storeData && schema.storeData.sql && schema.storeData.sql.singleQuery) {
        return schema.storeData.sql.singleQuery;
    }
    else {
        return "where " + schema.storeData.sql.tableName + "." + schema.idAttribute + " = ?";
    }
}
function bulkWhere(schema) {
    if (schema.storeData && schema.storeData.sql && schema.storeData.sql.bulkQuery) {
        return schema.storeData.sql.bulkQuery;
    }
    else if (schema.storeData && schema.storeData.sql && schema.storeData.sql.singleQuery) {
        return schema.storeData.sql.singleQuery;
    }
    else {
        return "where " + schema.storeData.sql.tableName + "." + schema.idAttribute + " = ?";
    }
}
function groupBy(schema) {
    return "group by " + Object.keys(schema.attributes).map(function (attrName) { return "\"" + attrName + "\""; }).join(', ');
}
function bulkQuery(schema) {
    return {
        queryString: selects(schema) + " \nfrom " + schema.storeData.sql.tableName + " \n" + joins(schema) + " \n" + bulkWhere(schema) + " \n" + groupBy(schema) + ";",
        fields: ['id']
    };
}
exports.bulkQuery = bulkQuery;
function readQuery(schema) {
    return {
        queryString: selects(schema) + " \nfrom " + schema.storeData.sql.tableName + " \n" + joins(schema) + " \n" + singleWhere(schema) + " \n" + groupBy(schema) + ";",
        fields: ['id'],
    };
}
exports.readQuery = readQuery;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9xdWVyeVN0cmluZy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUdBLGlCQUFpQixNQUFtQjtJQUNsQyxJQUFNLFdBQVcsR0FBRyxFQUFFLENBQUM7SUFDdkIsR0FBRyxDQUFDLENBQUMsSUFBTSxRQUFRLElBQUksTUFBTSxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUM7UUFDekMsV0FBVyxDQUFDLElBQUksQ0FBQyxPQUFJLE1BQU0sQ0FBQyxTQUFTLENBQUMsR0FBRyxDQUFDLFNBQVMsYUFBTSxRQUFRLE9BQUcsQ0FBQyxDQUFDO0lBQ3hFLENBQUM7SUFDRCxHQUFHLENBQUMsQ0FBQyxJQUFNLE9BQU8sSUFBSSxNQUFNLENBQUMsYUFBYSxDQUFDLENBQUMsQ0FBQztRQUMzQyxJQUFNLEdBQUcsR0FBRyxNQUFNLENBQUMsYUFBYSxDQUFDLE9BQU8sQ0FBQyxDQUFDLElBQUksQ0FBQztRQUMvQyxJQUFNLFNBQVMsR0FBRyxHQUFHLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxDQUFDLFNBQVMsQ0FBQztRQUMvQyxJQUFNLGNBQWMsR0FBRyxHQUFHLENBQUMsU0FBUyxDQUFDLEdBQUcsQ0FBQyxVQUFVLENBQUMsU0FBUyxDQUFDLENBQUM7UUFDL0QsSUFBTSxRQUFRLEdBQUcsRUFBRSxDQUFDO1FBQ3BCLEVBQUUsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDO1lBQ2YsR0FBRyxDQUFDLENBQUMsSUFBTSxLQUFLLElBQUksR0FBRyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUM7Z0JBQy9CLFFBQVEsQ0FBQyxJQUFJLENBQUMsTUFBSSxLQUFLLE1BQUcsRUFBRSxPQUFJLE9BQU8sYUFBTSxLQUFLLE9BQUcsQ0FBQyxDQUFDO1lBQ3pELENBQUM7UUFDSCxDQUFDO1FBQ0QsSUFBTSxXQUFXLEdBQUcsa0NBQWdDLFFBQVEsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLE1BQUcsQ0FBQztRQUMzRSxXQUFXLENBQUMsSUFBSSxDQUNkLGdIQUlpQixPQUFPLGFBQU0sY0FBYywyQkFDbEMsUUFBUSxDQUFDLE1BQU0sR0FBRyxXQUFXLEdBQUcsRUFBRSwwRUFJekIsT0FBTyxhQUFNLGNBQWMsb0RBRXhDLE9BQU8sT0FBRyxDQUNqQixDQUFDO0lBQ0osQ0FBQztJQUNELE1BQU0sQ0FBQyxZQUFVLFdBQVcsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFHLENBQUM7QUFDNUMsQ0FBQztBQUVELGVBQWUsTUFBbUI7SUFDaEMsSUFBTSxXQUFXLEdBQUcsRUFBRSxDQUFDO0lBQ3ZCLEdBQUcsQ0FBQyxDQUFDLElBQU0sT0FBTyxJQUFJLE1BQU0sQ0FBQyxhQUFhLENBQUMsQ0FBQyxDQUFDO1FBQzNDLElBQU0sR0FBRyxHQUFHLE1BQU0sQ0FBQyxhQUFhLENBQUMsT0FBTyxDQUFDLENBQUMsSUFBSSxDQUFDO1FBQy9DLElBQU0sUUFBUSxHQUFHLEdBQUcsQ0FBQyxTQUFTLENBQUMsR0FBRyxDQUFDO1FBQ25DLEVBQUUsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDO1lBQ3ZCLFdBQVcsQ0FBQyxJQUFJLENBQ2QscUJBQW1CLEdBQUcsQ0FBQyxTQUFTLENBQUMsR0FBRyxDQUFDLFNBQVMsY0FBUSxPQUFPLFdBQUssUUFBUSxDQUFDLFNBQVMsQ0FBQyxPQUFPLENBQUcsQ0FDaEcsQ0FBQztRQUNKLENBQUM7UUFBQyxJQUFJLENBQUMsQ0FBQztZQUNOLFdBQVcsQ0FBQyxJQUFJLENBQ2QscUJBQW1CLEdBQUcsQ0FBQyxTQUFTLENBQUMsR0FBRyxDQUFDLFNBQVMsY0FBUSxPQUFPLFFBQUk7bUJBQy9ELFVBQU8sT0FBTyxXQUFLLFFBQVEsQ0FBQyxVQUFVLENBQUMsT0FBTyxDQUFDLFdBQU0sTUFBTSxDQUFDLFNBQVMsQ0FBQyxHQUFHLENBQUMsU0FBUyxTQUFJLE1BQU0sQ0FBQyxXQUFhLENBQUEsQ0FDOUcsQ0FBQztRQUNKLENBQUM7SUFDSCxDQUFDO0lBQ0QsTUFBTSxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7QUFDaEMsQ0FBQztBQUVELHFCQUFxQixNQUFtQjtJQUN0QyxFQUFFLENBQUMsQ0FBQyxNQUFNLENBQUMsU0FBUyxJQUFJLE1BQU0sQ0FBQyxTQUFTLENBQUMsR0FBRyxJQUFJLE1BQU0sQ0FBQyxTQUFTLENBQUMsR0FBRyxDQUFDLFdBQVcsQ0FBQyxDQUFDLENBQUM7UUFDakYsTUFBTSxDQUFDLE1BQU0sQ0FBQyxTQUFTLENBQUMsR0FBRyxDQUFDLFdBQVcsQ0FBQztJQUMxQyxDQUFDO0lBQUMsSUFBSSxDQUFDLENBQUM7UUFDTixNQUFNLENBQUMsV0FBUyxNQUFNLENBQUMsU0FBUyxDQUFDLEdBQUcsQ0FBQyxTQUFTLFNBQUksTUFBTSxDQUFDLFdBQVcsU0FBTSxDQUFDO0lBQzdFLENBQUM7QUFDSCxDQUFDO0FBRUQsbUJBQW1CLE1BQW1CO0lBQ3BDLEVBQUUsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxTQUFTLElBQUksTUFBTSxDQUFDLFNBQVMsQ0FBQyxHQUFHLElBQUksTUFBTSxDQUFDLFNBQVMsQ0FBQyxHQUFHLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQztRQUMvRSxNQUFNLENBQUMsTUFBTSxDQUFDLFNBQVMsQ0FBQyxHQUFHLENBQUMsU0FBUyxDQUFDO0lBQ3hDLENBQUM7SUFBQyxJQUFJLENBQUMsRUFBRSxDQUFDLENBQUMsTUFBTSxDQUFDLFNBQVMsSUFBSSxNQUFNLENBQUMsU0FBUyxDQUFDLEdBQUcsSUFBSSxNQUFNLENBQUMsU0FBUyxDQUFDLEdBQUcsQ0FBQyxXQUFXLENBQUMsQ0FBQyxDQUFDO1FBQ3hGLE1BQU0sQ0FBQyxNQUFNLENBQUMsU0FBUyxDQUFDLEdBQUcsQ0FBQyxXQUFXLENBQUM7SUFDMUMsQ0FBQztJQUFDLElBQUksQ0FBQyxDQUFDO1FBQ04sTUFBTSxDQUFDLFdBQVMsTUFBTSxDQUFDLFNBQVMsQ0FBQyxHQUFHLENBQUMsU0FBUyxTQUFJLE1BQU0sQ0FBQyxXQUFXLFNBQU0sQ0FBQztJQUM3RSxDQUFDO0FBQ0gsQ0FBQztBQUVELGlCQUFpQixNQUFtQjtJQUNsQyxNQUFNLENBQUMsY0FBWSxNQUFNLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxVQUFVLENBQUMsQ0FBQyxHQUFHLENBQUMsVUFBQyxRQUFRLElBQUssT0FBQSxPQUFJLFFBQVEsT0FBRyxFQUFmLENBQWUsQ0FBQyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUcsQ0FBQztBQUNwRyxDQUFDO0FBRUQsbUJBQTBCLE1BQW1CO0lBQzNDLE1BQU0sQ0FBQztRQUNMLFdBQVcsRUFBSyxPQUFPLENBQUMsTUFBTSxDQUFDLGdCQUFXLE1BQU0sQ0FBQyxTQUFTLENBQUMsR0FBRyxDQUFDLFNBQVMsV0FBTSxLQUFLLENBQUMsTUFBTSxDQUFDLFdBQU0sU0FBUyxDQUFDLE1BQU0sQ0FBQyxXQUFNLE9BQU8sQ0FBQyxNQUFNLENBQUMsTUFBRztRQUMxSSxNQUFNLEVBQUUsQ0FBQyxJQUFJLENBQUM7S0FDZixDQUFDO0FBQ0osQ0FBQztBQUxELDhCQUtDO0FBRUQsbUJBQTBCLE1BQW1CO0lBQzNDLE1BQU0sQ0FBQztRQUNMLFdBQVcsRUFBSyxPQUFPLENBQUMsTUFBTSxDQUFDLGdCQUFXLE1BQU0sQ0FBQyxTQUFTLENBQUMsR0FBRyxDQUFDLFNBQVMsV0FBTSxLQUFLLENBQUMsTUFBTSxDQUFDLFdBQU0sV0FBVyxDQUFDLE1BQU0sQ0FBQyxXQUFNLE9BQU8sQ0FBQyxNQUFNLENBQUMsTUFBRztRQUM1SSxNQUFNLEVBQUUsQ0FBQyxJQUFJLENBQUM7S0FDZixDQUFDO0FBQ0osQ0FBQztBQUxELDhCQUtDIiwiZmlsZSI6InF1ZXJ5U3RyaW5nLmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgUGFyYW1ldGVyaXplZFF1ZXJ5IH0gZnJvbSAnLi9zZW1pUXVlcnknO1xuaW1wb3J0IHsgTW9kZWxTY2hlbWEgfSBmcm9tICdwbHVtcCc7XG5cbmZ1bmN0aW9uIHNlbGVjdHMoc2NoZW1hOiBNb2RlbFNjaGVtYSkge1xuICBjb25zdCBzZWxlY3RBcnJheSA9IFtdO1xuICBmb3IgKGNvbnN0IGF0dHJOYW1lIGluIHNjaGVtYS5hdHRyaWJ1dGVzKSB7XG4gICAgc2VsZWN0QXJyYXkucHVzaChgXCIke3NjaGVtYS5zdG9yZURhdGEuc3FsLnRhYmxlTmFtZX1cIi5cIiR7YXR0ck5hbWV9XCJgKTtcbiAgfVxuICBmb3IgKGNvbnN0IHJlbE5hbWUgaW4gc2NoZW1hLnJlbGF0aW9uc2hpcHMpIHtcbiAgICBjb25zdCByZWwgPSBzY2hlbWEucmVsYXRpb25zaGlwc1tyZWxOYW1lXS50eXBlO1xuICAgIGNvbnN0IG90aGVyTmFtZSA9IHJlbC5zaWRlc1tyZWxOYW1lXS5vdGhlck5hbWU7XG4gICAgY29uc3Qgb3RoZXJGaWVsZE5hbWUgPSByZWwuc3RvcmVEYXRhLnNxbC5qb2luRmllbGRzW290aGVyTmFtZV07XG4gICAgY29uc3QgZXh0cmFBZ2cgPSBbXTtcbiAgICBpZiAocmVsLmV4dHJhcykge1xuICAgICAgZm9yIChjb25zdCBleHRyYSBpbiByZWwuZXh0cmFzKSB7XG4gICAgICAgIGV4dHJhQWdnLnB1c2goYCcke2V4dHJhfSdgLCBgXCIke3JlbE5hbWV9XCIuXCIke2V4dHJhfVwiYCk7XG4gICAgICB9XG4gICAgfVxuICAgIGNvbnN0IGV4dHJhU3RyaW5nID0gYCwgJ21ldGEnLCBqc29uYl9idWlsZF9vYmplY3QoJHtleHRyYUFnZy5qb2luKCcsICcpfSlgO1xuICAgIHNlbGVjdEFycmF5LnB1c2goXG4gICAgICBgQ09BTEVTQ0UoXG4gICAgICAgIGFycmF5X2FnZyhcbiAgICAgICAgICBkaXN0aW5jdChcbiAgICAgICAgICAgIGpzb25iX2J1aWxkX29iamVjdChcbiAgICAgICAgICAgICAgJ2lkJywgXCIke3JlbE5hbWV9XCIuXCIke290aGVyRmllbGROYW1lfVwiXG4gICAgICAgICAgICAgICR7ZXh0cmFBZ2cubGVuZ3RoID8gZXh0cmFTdHJpbmcgOiAnJ31cbiAgICAgICAgICAgIClcbiAgICAgICAgICApXG4gICAgICAgIClcbiAgICAgICAgRklMVEVSIChXSEVSRSBcIiR7cmVsTmFtZX1cIi5cIiR7b3RoZXJGaWVsZE5hbWV9XCIgSVMgTk9UIE5VTEwpLFxuICAgICAgICAne30nKVxuICAgICAgYXMgXCIke3JlbE5hbWV9XCJgXG4gICAgKTtcbiAgfVxuICByZXR1cm4gYHNlbGVjdCAke3NlbGVjdEFycmF5LmpvaW4oJywgJyl9YDtcbn1cblxuZnVuY3Rpb24gam9pbnMoc2NoZW1hOiBNb2RlbFNjaGVtYSkge1xuICBjb25zdCBqb2luU3RyaW5ncyA9IFtdO1xuICBmb3IgKGNvbnN0IHJlbE5hbWUgaW4gc2NoZW1hLnJlbGF0aW9uc2hpcHMpIHtcbiAgICBjb25zdCByZWwgPSBzY2hlbWEucmVsYXRpb25zaGlwc1tyZWxOYW1lXS50eXBlO1xuICAgIGNvbnN0IHNxbEJsb2NrID0gcmVsLnN0b3JlRGF0YS5zcWw7XG4gICAgaWYgKHNxbEJsb2NrLmpvaW5RdWVyeSkge1xuICAgICAgam9pblN0cmluZ3MucHVzaChcbiAgICAgICAgYGxlZnQgb3V0ZXIgam9pbiAke3JlbC5zdG9yZURhdGEuc3FsLnRhYmxlTmFtZX0gYXMgXCIke3JlbE5hbWV9XCIgJHtzcWxCbG9jay5qb2luUXVlcnlbcmVsTmFtZV19YFxuICAgICAgKTtcbiAgICB9IGVsc2Uge1xuICAgICAgam9pblN0cmluZ3MucHVzaChcbiAgICAgICAgYGxlZnQgb3V0ZXIgam9pbiAke3JlbC5zdG9yZURhdGEuc3FsLnRhYmxlTmFtZX0gYXMgXCIke3JlbE5hbWV9XCIgYFxuICAgICAgICArIGBvbiBcIiR7cmVsTmFtZX1cIi4ke3NxbEJsb2NrLmpvaW5GaWVsZHNbcmVsTmFtZV19ID0gJHtzY2hlbWEuc3RvcmVEYXRhLnNxbC50YWJsZU5hbWV9LiR7c2NoZW1hLmlkQXR0cmlidXRlfWBcbiAgICAgICk7XG4gICAgfVxuICB9XG4gIHJldHVybiBqb2luU3RyaW5ncy5qb2luKCdcXG4nKTtcbn1cblxuZnVuY3Rpb24gc2luZ2xlV2hlcmUoc2NoZW1hOiBNb2RlbFNjaGVtYSkge1xuICBpZiAoc2NoZW1hLnN0b3JlRGF0YSAmJiBzY2hlbWEuc3RvcmVEYXRhLnNxbCAmJiBzY2hlbWEuc3RvcmVEYXRhLnNxbC5zaW5nbGVRdWVyeSkge1xuICAgIHJldHVybiBzY2hlbWEuc3RvcmVEYXRhLnNxbC5zaW5nbGVRdWVyeTtcbiAgfSBlbHNlIHtcbiAgICByZXR1cm4gYHdoZXJlICR7c2NoZW1hLnN0b3JlRGF0YS5zcWwudGFibGVOYW1lfS4ke3NjaGVtYS5pZEF0dHJpYnV0ZX0gPSA/YDtcbiAgfVxufVxuXG5mdW5jdGlvbiBidWxrV2hlcmUoc2NoZW1hOiBNb2RlbFNjaGVtYSkge1xuICBpZiAoc2NoZW1hLnN0b3JlRGF0YSAmJiBzY2hlbWEuc3RvcmVEYXRhLnNxbCAmJiBzY2hlbWEuc3RvcmVEYXRhLnNxbC5idWxrUXVlcnkpIHtcbiAgICByZXR1cm4gc2NoZW1hLnN0b3JlRGF0YS5zcWwuYnVsa1F1ZXJ5O1xuICB9IGVsc2UgaWYgKHNjaGVtYS5zdG9yZURhdGEgJiYgc2NoZW1hLnN0b3JlRGF0YS5zcWwgJiYgc2NoZW1hLnN0b3JlRGF0YS5zcWwuc2luZ2xlUXVlcnkpIHtcbiAgICByZXR1cm4gc2NoZW1hLnN0b3JlRGF0YS5zcWwuc2luZ2xlUXVlcnk7XG4gIH0gZWxzZSB7XG4gICAgcmV0dXJuIGB3aGVyZSAke3NjaGVtYS5zdG9yZURhdGEuc3FsLnRhYmxlTmFtZX0uJHtzY2hlbWEuaWRBdHRyaWJ1dGV9ID0gP2A7XG4gIH1cbn1cblxuZnVuY3Rpb24gZ3JvdXBCeShzY2hlbWE6IE1vZGVsU2NoZW1hKSB7XG4gIHJldHVybiBgZ3JvdXAgYnkgJHtPYmplY3Qua2V5cyhzY2hlbWEuYXR0cmlidXRlcykubWFwKChhdHRyTmFtZSkgPT4gYFwiJHthdHRyTmFtZX1cImApLmpvaW4oJywgJyl9YDtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGJ1bGtRdWVyeShzY2hlbWE6IE1vZGVsU2NoZW1hKTogUGFyYW1ldGVyaXplZFF1ZXJ5IHtcbiAgcmV0dXJuIHtcbiAgICBxdWVyeVN0cmluZzogYCR7c2VsZWN0cyhzY2hlbWEpfSBcXG5mcm9tICR7c2NoZW1hLnN0b3JlRGF0YS5zcWwudGFibGVOYW1lfSBcXG4ke2pvaW5zKHNjaGVtYSl9IFxcbiR7YnVsa1doZXJlKHNjaGVtYSl9IFxcbiR7Z3JvdXBCeShzY2hlbWEpfTtgLCAvLyB0c2xpbnQ6ZGlzYWJsZS1saW5lIG1heC1saW5lLWxlbmd0aFxuICAgIGZpZWxkczogWydpZCddXG4gIH07XG59XG5cbmV4cG9ydCBmdW5jdGlvbiByZWFkUXVlcnkoc2NoZW1hOiBNb2RlbFNjaGVtYSk6IFBhcmFtZXRlcml6ZWRRdWVyeSB7XG4gIHJldHVybiB7XG4gICAgcXVlcnlTdHJpbmc6IGAke3NlbGVjdHMoc2NoZW1hKX0gXFxuZnJvbSAke3NjaGVtYS5zdG9yZURhdGEuc3FsLnRhYmxlTmFtZX0gXFxuJHtqb2lucyhzY2hlbWEpfSBcXG4ke3NpbmdsZVdoZXJlKHNjaGVtYSl9IFxcbiR7Z3JvdXBCeShzY2hlbWEpfTtgLCAvLyB0c2xpbnQ6ZGlzYWJsZS1saW5lIG1heC1saW5lLWxlbmd0aFxuICAgIGZpZWxkczogWydpZCddLFxuICB9O1xufVxuIl19
