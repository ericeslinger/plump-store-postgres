"use strict";
exports.__esModule = true;
function selects(schema) {
    var selectArray = [];
    for (var attrName in schema.attributes) {
        selectArray.push("\"" + schema.storeData.sql.tableName + "\".\"" + attrName + "\"");
    }
    for (var relName in schema.relationships) {
        var rel = schema.relationships[relName].type;
        var otherName = rel.sides[relName].otherName;
        var otherFieldName = rel.storeData.sql.joinFields[otherName];
        var extraAgg = [];
        if (rel.extras) {
            for (var extra in rel.extras) {
                extraAgg.push("'" + extra + "'", "\"" + relName + "\".\"" + extra + "\"");
            }
        }
        var extraString = ", 'meta', jsonb_build_object(" + extraAgg.join(', ') + ")";
        selectArray.push("COALESCE(\n        array_agg(\n          distinct(\n            jsonb_build_object(\n              'id', \"" + relName + "\".\"" + otherFieldName + "\"\n              " + (extraAgg.length ? extraString : '') + "\n            )\n          )\n        )\n        FILTER (WHERE \"" + relName + "\".\"" + otherFieldName + "\" IS NOT NULL),\n        '{}')\n      as \"" + relName + "\"");
    }
    return "select " + selectArray.join(', ');
}
function joins(schema) {
    var joinStrings = [];
    for (var relName in schema.relationships) {
        var rel = schema.relationships[relName].type;
        var sqlBlock = rel.storeData.sql;
        if (sqlBlock.joinQuery) {
            joinStrings.push("left outer join " + rel.storeData.sql.tableName + " as \"" + relName + "\" " + sqlBlock.joinQuery[relName]);
        }
        else {
            joinStrings.push("left outer join " + rel.storeData.sql.tableName + " as \"" + relName + "\" "
                + ("on \"" + relName + "\"." + sqlBlock.joinFields[relName] + " = " + schema.storeData.sql.tableName + "." + schema.idAttribute));
        }
    }
    return joinStrings.join('\n');
}
function singleWhere(schema) {
    if (schema.storeData && schema.storeData.sql && schema.storeData.sql.singleQuery) {
        return schema.storeData.sql.singleQuery;
    }
    else {
        return "where " + schema.storeData.sql.tableName + "." + schema.idAttribute + " = ?";
    }
}
function bulkWhere(schema) {
    if (schema.storeData && schema.storeData.sql && schema.storeData.sql.bulkQuery) {
        return schema.storeData.sql.bulkQuery;
    }
    else if (schema.storeData && schema.storeData.sql && schema.storeData.sql.singleQuery) {
        return schema.storeData.sql.singleQuery;
    }
    else {
        return "where " + schema.storeData.sql.tableName + "." + schema.idAttribute + " = ?";
    }
}
function groupBy(schema) {
    return "group by " + Object.keys(schema.attributes).map(function (attrName) { return "\"" + attrName + "\""; }).join(', ');
}
function bulkQuery(schema) {
    return {
        queryString: selects(schema) + " \nfrom " + schema.storeData.sql.tableName + " \n" + joins(schema) + " \n" + bulkWhere(schema) + " \n" + groupBy(schema) + ";",
        fields: ['id']
    };
}
exports.bulkQuery = bulkQuery;
function readQuery(schema) {
    return {
        queryString: selects(schema) + " \nfrom " + schema.storeData.sql.tableName + " \n" + joins(schema) + " \n" + singleWhere(schema) + " \n" + groupBy(schema) + ";",
        fields: ['id']
    };
}
exports.readQuery = readQuery;

//# sourceMappingURL=data:application/json;charset=utf8;base64,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LE1BQU0sQ0FBQyxjQUFZLE1BQU0sQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLFVBQVUsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxVQUFDLFFBQVEsSUFBSyxPQUFBLE9BQUksUUFBUSxPQUFHLEVBQWYsQ0FBZSxDQUFDLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBRyxDQUFDO0FBQ3BHLENBQUM7QUFFRCxtQkFBMEIsTUFBbUI7SUFDM0MsTUFBTSxDQUFDO1FBQ0wsV0FBVyxFQUFLLE9BQU8sQ0FBQyxNQUFNLENBQUMsZ0JBQVcsTUFBTSxDQUFDLFNBQVMsQ0FBQyxHQUFHLENBQUMsU0FBUyxXQUFNLEtBQUssQ0FBQyxNQUFNLENBQUMsV0FBTSxTQUFTLENBQUMsTUFBTSxDQUFDLFdBQU0sT0FBTyxDQUFDLE1BQU0sQ0FBQyxNQUFHO1FBQzFJLE1BQU0sRUFBRSxDQUFDLElBQUksQ0FBQztLQUNmLENBQUM7QUFDSixDQUFDO0FBTEQsOEJBS0M7QUFFRCxtQkFBMEIsTUFBbUI7SUFDM0MsTUFBTSxDQUFDO1FBQ0wsV0FBVyxFQUFLLE9BQU8sQ0FBQyxNQUFNLENBQUMsZ0JBQVcsTUFBTSxDQUFDLFNBQVMsQ0FBQyxHQUFHLENBQUMsU0FBUyxXQUFNLEtBQUssQ0FBQyxNQUFNLENBQUMsV0FBTSxXQUFXLENBQUMsTUFBTSxDQUFDLFdBQU0sT0FBTyxDQUFDLE1BQU0sQ0FBQyxNQUFHO1FBQzVJLE1BQU0sRUFBRSxDQUFDLElBQUksQ0FBQztLQUNmLENBQUM7QUFDSixDQUFDO0FBTEQsOEJBS0MiLCJmaWxlIjoicXVlcnlTdHJpbmcuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBQYXJhbWV0ZXJpemVkUXVlcnkgfSBmcm9tICcuL3NlbWlRdWVyeSc7XG5pbXBvcnQgeyBNb2RlbFNjaGVtYSB9IGZyb20gJ3BsdW1wJztcblxuZnVuY3Rpb24gc2VsZWN0cyhzY2hlbWE6IE1vZGVsU2NoZW1hKSB7XG4gIGNvbnN0IHNlbGVjdEFycmF5ID0gW107XG4gIGZvciAoY29uc3QgYXR0ck5hbWUgaW4gc2NoZW1hLmF0dHJpYnV0ZXMpIHtcbiAgICBzZWxlY3RBcnJheS5wdXNoKGBcIiR7c2NoZW1hLnN0b3JlRGF0YS5zcWwudGFibGVOYW1lfVwiLlwiJHthdHRyTmFtZX1cImApO1xuICB9XG4gIGZvciAoY29uc3QgcmVsTmFtZSBpbiBzY2hlbWEucmVsYXRpb25zaGlwcykge1xuICAgIGNvbnN0IHJlbCA9IHNjaGVtYS5yZWxhdGlvbnNoaXBzW3JlbE5hbWVdLnR5cGU7XG4gICAgY29uc3Qgb3RoZXJOYW1lID0gcmVsLnNpZGVzW3JlbE5hbWVdLm90aGVyTmFtZTtcbiAgICBjb25zdCBvdGhlckZpZWxkTmFtZSA9IHJlbC5zdG9yZURhdGEuc3FsLmpvaW5GaWVsZHNbb3RoZXJOYW1lXTtcbiAgICBjb25zdCBleHRyYUFnZyA9IFtdO1xuICAgIGlmIChyZWwuZXh0cmFzKSB7XG4gICAgICBmb3IgKGNvbnN0IGV4dHJhIGluIHJlbC5leHRyYXMpIHtcbiAgICAgICAgZXh0cmFBZ2cucHVzaChgJyR7ZXh0cmF9J2AsIGBcIiR7cmVsTmFtZX1cIi5cIiR7ZXh0cmF9XCJgKTtcbiAgICAgIH1cbiAgICB9XG4gICAgY29uc3QgZXh0cmFTdHJpbmcgPSBgLCAnbWV0YScsIGpzb25iX2J1aWxkX29iamVjdCgke2V4dHJhQWdnLmpvaW4oJywgJyl9KWA7XG4gICAgc2VsZWN0QXJyYXkucHVzaChcbiAgICAgIGBDT0FMRVNDRShcbiAgICAgICAgYXJyYXlfYWdnKFxuICAgICAgICAgIGRpc3RpbmN0KFxuICAgICAgICAgICAganNvbmJfYnVpbGRfb2JqZWN0KFxuICAgICAgICAgICAgICAnaWQnLCBcIiR7cmVsTmFtZX1cIi5cIiR7b3RoZXJGaWVsZE5hbWV9XCJcbiAgICAgICAgICAgICAgJHtleHRyYUFnZy5sZW5ndGggPyBleHRyYVN0cmluZyA6ICcnfVxuICAgICAgICAgICAgKVxuICAgICAgICAgIClcbiAgICAgICAgKVxuICAgICAgICBGSUxURVIgKFdIRVJFIFwiJHtyZWxOYW1lfVwiLlwiJHtvdGhlckZpZWxkTmFtZX1cIiBJUyBOT1QgTlVMTCksXG4gICAgICAgICd7fScpXG4gICAgICBhcyBcIiR7cmVsTmFtZX1cImBcbiAgICApO1xuICB9XG4gIHJldHVybiBgc2VsZWN0ICR7c2VsZWN0QXJyYXkuam9pbignLCAnKX1gO1xufVxuXG5mdW5jdGlvbiBqb2lucyhzY2hlbWE6IE1vZGVsU2NoZW1hKSB7XG4gIGNvbnN0IGpvaW5TdHJpbmdzID0gW107XG4gIGZvciAoY29uc3QgcmVsTmFtZSBpbiBzY2hlbWEucmVsYXRpb25zaGlwcykge1xuICAgIGNvbnN0IHJlbCA9IHNjaGVtYS5yZWxhdGlvbnNoaXBzW3JlbE5hbWVdLnR5cGU7XG4gICAgY29uc3Qgc3FsQmxvY2sgPSByZWwuc3RvcmVEYXRhLnNxbDtcbiAgICBpZiAoc3FsQmxvY2suam9pblF1ZXJ5KSB7XG4gICAgICBqb2luU3RyaW5ncy5wdXNoKFxuICAgICAgICBgbGVmdCBvdXRlciBqb2luICR7cmVsLnN0b3JlRGF0YS5zcWwudGFibGVOYW1lfSBhcyBcIiR7cmVsTmFtZX1cIiAke3NxbEJsb2NrLmpvaW5RdWVyeVtyZWxOYW1lXX1gXG4gICAgICApO1xuICAgIH0gZWxzZSB7XG4gICAgICBqb2luU3RyaW5ncy5wdXNoKFxuICAgICAgICBgbGVmdCBvdXRlciBqb2luICR7cmVsLnN0b3JlRGF0YS5zcWwudGFibGVOYW1lfSBhcyBcIiR7cmVsTmFtZX1cIiBgXG4gICAgICAgICsgYG9uIFwiJHtyZWxOYW1lfVwiLiR7c3FsQmxvY2suam9pbkZpZWxkc1tyZWxOYW1lXX0gPSAke3NjaGVtYS5zdG9yZURhdGEuc3FsLnRhYmxlTmFtZX0uJHtzY2hlbWEuaWRBdHRyaWJ1dGV9YFxuICAgICAgKTtcbiAgICB9XG4gIH1cbiAgcmV0dXJuIGpvaW5TdHJpbmdzLmpvaW4oJ1xcbicpO1xufVxuXG5mdW5jdGlvbiBzaW5nbGVXaGVyZShzY2hlbWE6IE1vZGVsU2NoZW1hKSB7XG4gIGlmIChzY2hlbWEuc3RvcmVEYXRhICYmIHNjaGVtYS5zdG9yZURhdGEuc3FsICYmIHNjaGVtYS5zdG9yZURhdGEuc3FsLnNpbmdsZVF1ZXJ5KSB7XG4gICAgcmV0dXJuIHNjaGVtYS5zdG9yZURhdGEuc3FsLnNpbmdsZVF1ZXJ5O1xuICB9IGVsc2Uge1xuICAgIHJldHVybiBgd2hlcmUgJHtzY2hlbWEuc3RvcmVEYXRhLnNxbC50YWJsZU5hbWV9LiR7c2NoZW1hLmlkQXR0cmlidXRlfSA9ID9gO1xuICB9XG59XG5cbmZ1bmN0aW9uIGJ1bGtXaGVyZShzY2hlbWE6IE1vZGVsU2NoZW1hKSB7XG4gIGlmIChzY2hlbWEuc3RvcmVEYXRhICYmIHNjaGVtYS5zdG9yZURhdGEuc3FsICYmIHNjaGVtYS5zdG9yZURhdGEuc3FsLmJ1bGtRdWVyeSkge1xuICAgIHJldHVybiBzY2hlbWEuc3RvcmVEYXRhLnNxbC5idWxrUXVlcnk7XG4gIH0gZWxzZSBpZiAoc2NoZW1hLnN0b3JlRGF0YSAmJiBzY2hlbWEuc3RvcmVEYXRhLnNxbCAmJiBzY2hlbWEuc3RvcmVEYXRhLnNxbC5zaW5nbGVRdWVyeSkge1xuICAgIHJldHVybiBzY2hlbWEuc3RvcmVEYXRhLnNxbC5zaW5nbGVRdWVyeTtcbiAgfSBlbHNlIHtcbiAgICByZXR1cm4gYHdoZXJlICR7c2NoZW1hLnN0b3JlRGF0YS5zcWwudGFibGVOYW1lfS4ke3NjaGVtYS5pZEF0dHJpYnV0ZX0gPSA/YDtcbiAgfVxufVxuXG5mdW5jdGlvbiBncm91cEJ5KHNjaGVtYTogTW9kZWxTY2hlbWEpIHtcbiAgcmV0dXJuIGBncm91cCBieSAke09iamVjdC5rZXlzKHNjaGVtYS5hdHRyaWJ1dGVzKS5tYXAoKGF0dHJOYW1lKSA9PiBgXCIke2F0dHJOYW1lfVwiYCkuam9pbignLCAnKX1gO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gYnVsa1F1ZXJ5KHNjaGVtYTogTW9kZWxTY2hlbWEpOiBQYXJhbWV0ZXJpemVkUXVlcnkge1xuICByZXR1cm4ge1xuICAgIHF1ZXJ5U3RyaW5nOiBgJHtzZWxlY3RzKHNjaGVtYSl9IFxcbmZyb20gJHtzY2hlbWEuc3RvcmVEYXRhLnNxbC50YWJsZU5hbWV9IFxcbiR7am9pbnMoc2NoZW1hKX0gXFxuJHtidWxrV2hlcmUoc2NoZW1hKX0gXFxuJHtncm91cEJ5KHNjaGVtYSl9O2AsIC8vIHRzbGludDpkaXNhYmxlLWxpbmUgbWF4LWxpbmUtbGVuZ3RoXG4gICAgZmllbGRzOiBbJ2lkJ11cbiAgfTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHJlYWRRdWVyeShzY2hlbWE6IE1vZGVsU2NoZW1hKTogUGFyYW1ldGVyaXplZFF1ZXJ5IHtcbiAgcmV0dXJuIHtcbiAgICBxdWVyeVN0cmluZzogYCR7c2VsZWN0cyhzY2hlbWEpfSBcXG5mcm9tICR7c2NoZW1hLnN0b3JlRGF0YS5zcWwudGFibGVOYW1lfSBcXG4ke2pvaW5zKHNjaGVtYSl9IFxcbiR7c2luZ2xlV2hlcmUoc2NoZW1hKX0gXFxuJHtncm91cEJ5KHNjaGVtYSl9O2AsIC8vIHRzbGludDpkaXNhYmxlLWxpbmUgbWF4LWxpbmUtbGVuZ3RoXG4gICAgZmllbGRzOiBbJ2lkJ10sXG4gIH07XG59XG4iXX0=
